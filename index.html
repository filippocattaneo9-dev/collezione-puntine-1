<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collezione Puntine e Gestione Carte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 900px; 
        }
        .header {
            color: #4f46e5;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s;
            display: block;
            width: 100%;
            text-align: center;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #4f46e5;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-admin {
            background-color: #fef3c7;
            color: #d97706;
        }
        .badge-user {
            background-color: #e0f2f1;
            color: #0d9488;
        }
        .badge-pending {
            background-color: #fee2e2;
            color: #ef4444;
        }
        .badge-confirmed {
            background-color: #d1fae5;
            color: #059669;
        }
        /* Stile specifico per il calendario */
        .calendar-box {
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            background-color: white;
        }
        .calendar-event {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .calendar-event:hover {
            background-color: #fde2e2; /* Colore hover per eventi */
        }
        /* Stile specifico per card di credito */
        .credit-card {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .card-number {
            font-family: monospace;
            font-size: 1.5rem;
            letter-spacing: 3px;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            display: block;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        /* Stili per Tab Lavori */
        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #6b7280;
        }
        .tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }
        @media (min-width: 640px) {
            body {
                align-items: center;
            }
        }
    </style>
</head>
<body>

    <div id="app-container" class="card">
        <h1 class="text-3xl header">Collezione Puntine</h1>
        <div id="loader" class="text-center text-gray-500 py-8">Connessione a Firebase...</div>
        <div id="content" class="hidden"></div>
    </div>

    <script>
        // NON MODIFICARE QUESTA VARIABILE
        const __app_id = 'thumbtack-collector-v1'; 
        
        // CONFIGURAZIONE REALE DEL PROGETTO 'puntine-collector'
        const firebaseConfig = {
            apiKey: "AIzaSyA6DwPiwQoRCxEC-lmlYJrchpLqzBEYB5w",
            authDomain: "puntine-collector.firebaseapp.com",
            projectId: "puntine-collector",
            storageBucket: "puntine-collector.firebasestorage.app",
            messagingSenderId: "709491476433",
            appId: "1:709491476433:web:cfcfc6d94bc2a5ef41c2f0"
        };
        
        // Stato globale
        window.currentCalendarDate = new Date(); 
        window.calendarEvents = [];
        window.fakeCreditCards = []; 
        window.epuntListings = []; 
        window.jobApplications = []; // NUOVO: Per candidature
        
        // NUOVO: Definizione Lavori
        window.AVAILABLE_JOBS = {
            'nurse': 'Infermiere',
            'banker': 'Banchiere',
            'musician': 'Musicista',
            'gamedev': 'Design Videogiochi'
        };
        
        // NUOVO: Logica Pagamento Infermiere
        window.NURSE_PAY_PER_THUMBTACK = 10; // 10 EUR finti per ogni puntina
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, orderBy, limit, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        setLogLevel('Debug'); // Mostra i log di Firestore nella console per il debug
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const config = firebaseConfig; 

        // --- GLOBAL STATE & FIREBASE SETUP ---
        const app = initializeApp(config);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentUserId = null;
        let currentUserData = null;
        let isAdmin = false;

        // Credenziali hardcoded per il primo login Admin
        const ADMIN_USERNAME = "florianopu19";
        const ADMIN_PASSWORD = "1e2r3t";

        const RANKS = [
            'Non classificato',
            'Socio anziano',
            'Vice presidente',
            'Presidente'
        ];

        // --- HELPER FUNCTIONS ---

        const getRequestsCollection = () => collection(db, `artifacts/${appId}/public/data/thumbtack_requests`);
        const getAdminUsersCollection = () => collection(db, `artifacts/${appId}/public/data/all_users_view`); 
        const getEventsCollection = () => collection(db, `artifacts/${appId}/public/data/calendar_events`); 
        const getCardsCollection = () => collection(db, `artifacts/${appId}/public/data/fake_credit_cards`);
        const getEpuntListingsCollection = () => collection(db, `artifacts/${appId}/public/data/epunt_listings`); 
        
        // NUOVI HELPERS PER LAVORI
        const getJobApplicationsCollection = () => collection(db, `artifacts/${appId}/public/data/job_applications`);
        const getUserInfractionsCollection = (username) => collection(db, `artifacts/${appId}/public/data/all_users_view/${username}/infractions`);


        const showView = (html) => {
            document.getElementById('content').innerHTML = html;
        };
        
        const showLoader = (show) => {
            document.getElementById('loader').classList.toggle('hidden', !show);
            document.getElementById('content').classList.toggle('hidden', show);
        };

        // Formattazione per la valuta
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        };

        // Simple modal implementation (to replace alert/confirm)
        const showMessageBox = (title, message, type = 'info', confirmCallback = null) => {
            let color = 'bg-blue-500';
            if (type === 'success') color = 'bg-green-500';
            if (type === 'error') color = 'bg-red-500';
            if (type === 'alert') color = 'bg-yellow-500';

            const container = document.getElementById('app-container');
            const existingModal = document.getElementById('custom-modal');
            if (existingModal) existingModal.remove();

            const isConfirmation = confirmCallback !== null;
            const modalHTML = `
                <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="card max-w-sm">
                        <div class="flex items-center pb-3 border-b border-gray-200">
                            <div class="h-2 w-2 ${color} rounded-full mr-3"></div>
                            <h3 class="text-lg font-bold text-gray-900">${title}</h3>
                        </div>
                        <div class="py-4 text-gray-700">${message}</div>
                        <div class="flex justify-end space-x-3">
                            ${isConfirmation ? 
                                `<button id="modal-cancel" class="btn-secondary px-4 py-2">Annulla</button>
                                <button id="modal-confirm" class="${color.replace('bg-', 'bg-')} text-white px-4 py-2 rounded-lg font-semibold">Conferma</button>`
                                : 
                                `<button id="modal-ok" class="btn-primary px-4 py-2">OK</button>`
                            }
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('afterend', modalHTML);

            const modal = document.getElementById('custom-modal');
            
            const close = () => modal.remove();

            if (isConfirmation) {
                document.getElementById('modal-cancel').onclick = close;
                document.getElementById('modal-confirm').onclick = () => {
                    confirmCallback();
                    close();
                };
            } else {
                document.getElementById('modal-ok').onclick = close;
            }
        };


        // --- AUTHENTICATION & INITIAL SETUP ---

        const initializeAuth = async () => {
            showLoader(true);
            try {
                // Tentativo di autenticazione anonima
                await signInAnonymously(auth); 
            } catch (error) {
                console.error("Errore nell'autenticazione iniziale:", error);
                showMessageBox("Errore Critico", "Impossibile connettersi ai servizi di autenticazione Firebase. Controlla la tua configurazione.", "error");
            }
        };

        const handleSignIn = async (username, password, email = '') => { 
            showLoader(true); 

            if (!username || !password) {
                showMessageBox("Attenzione", "Inserisci username e password.", "alert");
                showLoader(false);
                return;
            }
            
            const userRef = doc(getAdminUsersCollection(), username);
            
            try {
                const userSnap = await getDoc(userRef);

                let userData;
                
                if (userSnap.exists()) {
                    // 1. Login
                    userData = userSnap.data();

                    if (userData.password !== password) {
                        showMessageBox("Errore di accesso", "Password errata per l'utente " + username + ".", "error");
                        showLoader(false);
                        return;
                    }

                    if (userData.authUid !== currentUserId) {
                        await updateDoc(userRef, { authUid: currentUserId });
                    }

                } else {
                    // 2. Registration
                    const isNewAdmin = (username === ADMIN_USERNAME && password === ADMIN_PASSWORD);
                    const initialRank = isNewAdmin ? 'Presidente' : 'Non classificato';
                    const initialRole = isNewAdmin ? 'admin' : 'user';

                    if (isNewAdmin) {
                        showMessageBox("Accesso Admin", `Benvenuto Admin ${username}! Sei loggato come ${initialRank}.`, "success");
                    } else {
                        showMessageBox("Registrazione Riuscita", `Benvenuto ${username}! Sei stato registrato con il grado ${initialRank}.`, "success");
                    }

                    userData = {
                        username: username,
                        password: password, 
                        email: email, 
                        authUid: currentUserId,
                        role: initialRole,
                        rank: initialRank,
                        totalThumbtacks: 0,
                        job: null, // NUOVO CAMPO: Lavoro
                        quitCount: 0, // NUOVO CAMPO: Contatore dimissioni
                        lastUpdate: new Date().toISOString()
                    };

                    await setDoc(userRef, userData);
                }

                // --- GESTIONE FLUSSO DOPO LOGIN/REGISTRAZIONE ---
                currentUserData = userData;
                isAdmin = currentUserData.role === 'admin';
                
                if (isAdmin && currentUserData.password === ADMIN_PASSWORD) {
                    renderAdminPasswordChangePrompt();
                    showLoader(false);
                    return; 
                }

                startListeningForData();

                if (isAdmin) {
                    renderAdminDashboard();
                } else {
                    renderUserDashboard();
                }

            } catch (error) {
                console.error("Errore durante il login/registrazione:", error);
                showMessageBox("Errore di Sistema", "Si è verificato un errore durante l'accesso. Controlla la console.", "error");
            }
            showLoader(false);
        };

        const handleLogout = async () => {
            try {
                // Ricarica la pagina per resettare lo stato di autenticazione anonimo
                location.reload(); 
            } catch (error) {
                console.error("Logout failed:", error);
            }
        };

        // --- UI MANAGEMENT ---
        const renderWelcomeScreen = () => {
            const html = `
                <p class="text-gray-600 text-center mb-6">Benvenuto nel sistema di collezione di puntine!</p>
                <div id="auth-view">
                    <div id="login-form">
                        <input type="text" id="username" placeholder="Username" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
                        <input type="email" id="email" placeholder="Email (solo per la registrazione, facoltativa)" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
                        <input type="password" id="password" placeholder="Password" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
                        <button onclick="window.handleLoginClick()" class="btn-primary mb-3">Accedi / Registrati</button>
                        <p class="text-sm text-gray-500 text-center mt-4">
                            Il tuo ID di sessione (per debug): <code class="text-xs break-words">${currentUserId || 'N/D'}</code>
                        </p>
                    </div>
                </div>
            `;
            showView(html);
        };

        const handleLoginClick = () => {
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            handleSignIn(username, password, email);
        };

        const renderAdminPasswordChangePrompt = () => {
            const html = `
                <div class="bg-yellow-100 p-4 rounded-lg mb-6 border border-yellow-300">
                    <h2 class="text-xl font-bold text-yellow-800 mb-2">⚠ SICUREZZA CRITICA ⚠</h2>
                    <p class="text-yellow-700 mb-4">
                        Stai utilizzando la password Admin predefinita. Per motivi di sicurezza, devi cambiarla per accedere alla Dashboard.
                    </p>
                    <input type="password" id="new_password" placeholder="Nuova Password (min 6 caratteri)" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" />
                    <input type="password" id="confirm_password" placeholder="Conferma Nuova Password" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" />
                    <button onclick="window.handleAdminPasswordChange()" class="btn-primary bg-red-600 hover:bg-red-700">Cambia Password Admin</button>
                </div>
            `;
            showView(html);
        };

        const handleAdminPasswordChange = async () => {
            const newPassword = document.getElementById('new_password').value.trim();
            const confirmPassword = document.getElementById('confirm_password').value.trim();
            const adminUsername = currentUserData.username;

            if (newPassword.length < 6) {
                showMessageBox("Attenzione", "La nuova password deve contenere almeno 6 caratteri.", "alert");
                return;
            }
            if (newPassword !== confirmPassword) {
                showMessageBox("Attenzione", "Le password non corrispondono.", "alert");
                return;
            }
            if (newPassword === ADMIN_PASSWORD) {
                showMessageBox("Attenzione", "La nuova password non può essere uguale a quella predefinita.", "alert");
                return;
            }

            showLoader(true);
            try {
                const userRef = doc(getAdminUsersCollection(), adminUsername);
                await updateDoc(userRef, {
                    password: newPassword,
                    lastUpdate: new Date().toISOString()
                });

                currentUserData.password = newPassword; 

                showMessageBox("Successo", "Password Admin aggiornata con successo! Accesso alla Dashboard.", "success", () => {
                    startListeningForData();
                    renderAdminDashboard();
                });

            } catch (error) {
                console.error("Errore nel cambio password Admin:", error);
                showMessageBox("Errore di Sistema", "Impossibile aggiornare la password. Controlla la console.", "error");
            }
            showLoader(false);
        };


        // --- USER DASHBOARD ---

        const renderUserDashboard = () => {
            const thumbtackRequests = window.thumbtackRequests || [];
            const userCards = window.fakeCreditCards || []; // Le carte dell'utente

            // Filtra le richieste dell'utente corrente (basandosi sull'UID)
            const userRequests = thumbtackRequests.filter(r => r.authUid === currentUserId);
            const userPendingRequests = userRequests.filter(r => r.status === 'Pending');
            const userHistoryRequests = userRequests.filter(r => r.status !== 'Pending');

            let pendingRequestsHTML = '';
            if (userPendingRequests.length > 0) {
                pendingRequestsHTML = `
                    <h3 class="text-lg font-semibold mt-6 mb-3 text-red-600">Richieste in Sospeso</h3>
                    <div class="border rounded-lg overflow-hidden">
                    ${userPendingRequests.map(req => `
                        <div class="list-item bg-red-50/50">
                            <span>${req.quantity} puntine (${new Date(req.timestamp).toLocaleDateString()})</span>
                            <span class="badge badge-pending">In attesa</span>
                        </div>
                    `).join('')}
                    </div>
                `;
            }

            let cardListHTML = '';
            if (userCards.length > 0) {
                cardListHTML = userCards.map(card => `
                    <div class="credit-card mb-4">
                        <p class="text-sm font-light">Carta Finta Registrata</p>
                        <span class="card-number">${card.id.replace(/(\d{4})/g, '$1 ').trim()}</span>
                        <div class="flex justify-between items-center text-xl font-bold">
                            <p>Saldo Attuale:</p>
                            <p class="text-green-300">${formatCurrency(card.balance)}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                 cardListHTML = `<p class="text-center text-gray-500 py-4">Nessuna carta registrata. Registrane una qui sotto!</p>`;
            }
            
            // NUOVO: Info Lavoro
            let jobInfoHtml = '';
            if (currentUserData.job) {
                const jobName = window.AVAILABLE_JOBS[currentUserData.job] || currentUserData.job;
                jobInfoHtml = `<p class="text-indigo-700 text-sm mt-1">Lavoro: <span class="font-bold">${jobName}</span></p>`;
            } else {
                jobInfoHtml = `<p class="text-indigo-700 text-sm mt-1">Lavoro: <span class="font-bold">Disoccupato</span></p>`;
            }


            const html = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">${currentUserData.username}</h2>
                    <button onclick="window.handleLogout()" class="text-sm text-red-500 hover:text-red-700">Logout</button>
                </div>

                <div class="bg-indigo-50 p-4 rounded-lg mb-6 shadow-inner">
                    <p class="text-indigo-700 text-sm">Il tuo Grado: <span class="font-bold">${currentUserData.rank}</span></p>
                    <p class="text-indigo-700 text-sm mt-1">Puntine Totali: <span class="font-bold text-xl">${currentUserData.totalThumbtacks}</span></p>
                    ${jobInfoHtml} ${currentUserData.email ? `<p class="text-indigo-700 text-xs mt-1">Email: ${currentUserData.email}</p>` : ''}
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <button onclick="window.renderCalendarView()" class="btn-primary">Calendario Eventi</button>
                    <button onclick="window.renderEpuntMarketplace()" class="btn-primary bg-green-600 hover:bg-green-700">🛒 Mercatino ePunt</button>
                    <button onclick="window.renderJobsView()" class="btn-primary bg-yellow-500 hover:bg-yellow-600">💼 Gestione Lavori</button>
                </div>
                
                
                <h3 class="text-xl font-bold text-gray-700 mb-3 mt-6 border-b pb-2">Gestione Carte di Credito Finte</h3>
                <div id="card-list" class="mb-6">
                    ${cardListHTML}
                </div>
                
                <div class="p-4 border border-gray-200 rounded-lg mb-8">
                    <h4 class="text-lg font-semibold mb-3 text-gray-700">Registra Nuova Carta (12 Cifre)</h4>
                    <input type="text" id="card_number_input" placeholder="XXXX XXXX XXXX" maxlength="12" pattern="[0-9]{12}" 
                        oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 12);" 
                        class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-center text-lg font-mono" />
                    <button onclick="window.registerNewCard()" class="btn-primary">Registra Carta</button>
                </div>
                <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">Invia Richiesta Puntine</h3>
                <div class="p-4 border border-gray-200 rounded-lg">
                    <label for="thumbtack_count" class="block text-sm font-medium text-gray-700 mb-2">Quante puntine hai collezionato?</label>
                    <input type="number" id="thumbtack_count" min="1" value="1" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
                    <button onclick="window.submitThumbtackRequest()" class="btn-primary">Invia per Approvazione</button>
                </div>
                
                ${pendingRequestsHTML}
                
                ${userHistoryRequests.length > 0 ? `
                    <h3 class="text-lg font-semibold mt-6 mb-3 text-gray-700">Storico Richieste Recenti</h3>
                    <div class="border rounded-lg overflow-hidden">
                    ${userHistoryRequests.map((req, index) => {
                        const isConfirmed = req.status === 'Confirmed';
                        const badgeClass = isConfirmed ? 'badge-confirmed' : 'badge-pending';
                        const badgeText = isConfirmed ? 'Accettata' : 'Rifiutata';
                        const bgColor = isConfirmed ? 'bg-green-50/50' : 'bg-red-50/50';

                        return `
                            <div class="list-item ${bgColor}">
                                <span>${req.quantity} puntine (${new Date(req.timestamp).toLocaleDateString()})</span>
                                <span class="badge ${badgeClass}">${badgeText}</span>
                            </div>
                        `;
                    }).join('')}
                    </div>
                ` : ''}
            `;
            showView(html);
        };
        
        // --- ADMIN DASHBOARD ---

        const renderAdminDashboard = () => {
            const allUsers = window.allUsers || [];
            const thumbtackRequests = (window.thumbtackRequests || []).filter(r => r.status === 'Pending');
            const allCards = window.fakeCreditCards || [];
            
            // NUOVO: Conteggio candidature pendenti
            const pendingApplicationsCount = (window.jobApplications || []).filter(app => app.status === 'pending').length;

             const usersHtml = allUsers.map((user, index) => {
                const currentRankIndex = RANKS.indexOf(user.rank);
                const nextRankIndex = currentRankIndex < RANKS.length - 1 ? currentRankIndex + 1 : currentRankIndex;
                const nextRankName = RANKS[nextRankIndex];
                
                // NUOVO: Info Lavoro Admin
                const jobName = user.job ? (window.AVAILABLE_JOBS[user.job] || user.job) : 'N/A';

                return `
                    <div class="list-item ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                        <div class="flex-1 min-w-0 mr-4">
                            <p class="font-semibold text-gray-900">${user.username} ${user.username === ADMIN_USERNAME ? '<span class="badge badge-admin ml-2">ADMIN</span>' : ''}</p>
                            <p class="text-sm text-gray-500">Puntine: ${user.totalThumbtacks} | Grado: ${user.rank} | Lavoro: ${jobName}</p>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                        ${user.username !== ADMIN_USERNAME ? `
                            <button onclick="window.handleRankChange('${user.username}')" 
                                    class="text-xs font-semibold py-1 px-3 rounded-full text-white transition-opacity ${RANKS.indexOf(user.rank) < RANKS.length - 1 ? 'bg-indigo-500 hover:bg-indigo-600' : 'bg-green-500 opacity-70 cursor-default'}" 
                                    ${currentRankIndex === RANKS.length - 1 ? 'disabled' : ''}>
                                ${currentRankIndex < RANKS.length - 1 ? `Promuovi a ${nextRankName}` : 'Grado Massimo'}
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            const requestsHtml = thumbtackRequests.length > 0 ? thumbtackRequests.map((req, index) => `
                <div class="list-item ${index % 2 === 0 ? 'bg-red-50' : 'bg-white'}">
                    <div class="flex-1 min-w-0 mr-4">
                        <p class="font-semibold text-gray-900">${req.username} richiede ${req.quantity} puntine.</p>
                        <p class="text-xs text-gray-500">${new Date(req.timestamp).toLocaleString()}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.handleRequestAction('${req.id}', 'Accept', ${req.quantity}, '${req.authUid}', '${req.username}')" 
                                class="bg-green-500 hover:bg-green-600 text-white text-xs font-semibold py-1 px-3 rounded-lg">Accetta</button>
                        <button onclick="window.handleRequestAction('${req.id}', 'Reject', ${req.quantity}, '${req.authUid}', '${req.username}')" 
                                class="bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-1 px-3 rounded-lg">Rifiuta</button>
                    </div>
                </div>
            `).join('') : '<p class="text-center text-gray-500 py-4">Nessuna richiesta di puntine in sospeso.</p>';
            
            // HTML per la lista di TUTTE le Carte
            const adminCardsHtml = allCards.length > 0 ? allCards.map((card, index) => `
                <div class="list-item ${index % 2 === 0 ? 'bg-indigo-50' : 'bg-white'} flex-wrap sm:flex-nowrap">
                    <div class="flex-1 min-w-0 mr-4 p-1">
                        <p class="font-bold text-gray-900 text-lg font-mono">${card.id.replace(/(\d{4})/g, '$1 ').trim()}</p>
                        <p class="text-sm text-gray-500">Proprietario: <span class="font-semibold">${card.ownerUsername}</span></p>
                    </div>
                    <div class="min-w-0 mr-4 p-1">
                        <p class="text-lg font-bold text-indigo-600 whitespace-nowrap">Saldo: ${formatCurrency(card.balance)}</p>
                    </div>
                    <div class="flex space-x-2 mt-2 sm:mt-0">
                        <button onclick="window.renderBalanceModal('${card.id}', ${card.balance}, '${card.ownerUsername}')" 
                                class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-semibold py-1 px-3 rounded-lg min-w-[100px]">Modifica</button>
                        <button onclick="window.handleAdminCardAction('${card.id}', 'delete')" 
                                class="bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-1 px-3 rounded-lg min-w-[80px]">Rimuovi</button>
                    </div>
                </div>
            `).join('') : '<p class="text-center text-gray-500 py-4">Nessuna carta finta registrata nel sistema.</p>';


            const html = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Dashboard Admin</h2>
                    <div class="flex space-x-3 flex-wrap">
                        <button onclick="window.renderJobsView()" class="text-sm font-semibold text-yellow-600 hover:text-yellow-800 relative">
                            Gestione Lavori
                            ${pendingApplicationsCount > 0 ? `<span class="absolute -top-2 -right-2 h-5 w-5 rounded-full bg-red-500 text-white text-xs flex items-center justify-center">${pendingApplicationsCount}</span>` : ''}
                        </button>
                        <button onclick="window.renderEpuntMarketplace()" class="text-sm font-semibold text-green-600 hover:text-green-800">Mercatino ePunt</button>
                        <button onclick="window.renderCalendarView()" class="text-sm font-semibold text-indigo-500 hover:text-indigo-700">Calendario</button>
                        <button onclick="window.handleLogout()" class="text-sm text-red-500 hover:text-red-700">Logout</button>
                    </div>
                </div>

                <div class="bg-red-100 p-4 rounded-lg mb-6">
                    <h3 class="text-xl font-bold text-red-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        Richieste Puntine Pendenti
                        ${thumbtackRequests.length > 0 ? `<span class="badge badge-pending ml-3">${thumbtackRequests.length}</span>` : ''}
                    </h3>
                </div>
                
                <div class="border rounded-lg overflow-hidden mb-8">
                    ${requestsHtml}
                </div>
                
                <h3 class="text-xl font-bold text-indigo-700 mb-3 border-b pb-2">Gestione Carte di Credito Finte (Globale)</h3>
                <div class="border rounded-lg overflow-hidden mb-8">
                    ${adminCardsHtml}
                </div>
                
                <h3 class="text-xl font-bold text-gray-700 mb-3">Gestione Utenti (Grado e Statistiche)</h3>
                <div class="border rounded-lg overflow-hidden">
                    ${usersHtml}
                </div>
            `;
            showView(html);
        };
        
        // --- CARD MANAGEMENT LOGIC ---

        const isValidCardNumber = (cardNumber) => {
            const cleaned = cardNumber.replace(/\s/g, '');
            return /^\d{12}$/.test(cleaned);
        };

        const registerNewCard = async () => {
            const input = document.getElementById('card_number_input');
            const cardNumber = input.value.trim();

            if (!isValidCardNumber(cardNumber)) {
                showMessageBox("Errore", "Il numero di carta deve essere esattamente di 12 cifre numeriche.", "error");
                return;
            }
            
            // Verifica se la carta esiste già
            const cardRef = doc(getCardsCollection(), cardNumber);
            const cardSnap = await getDoc(cardRef);

            if (cardSnap.exists()) {
                showMessageBox("Errore", "Questa carta è già stata registrata nel sistema.", "error");
                return;
            }
            
            showLoader(true);
            try {
                const newCardData = {
                    ownerUid: currentUserId,
                    ownerUsername: currentUserData.username,
                    balance: 0.00, // Inizia con saldo zero
                    createdAt: new Date().toISOString()
                };

                // Uso il numero di carta come ID del documento
                await setDoc(cardRef, newCardData);
                input.value = '';
                showMessageBox("Successo", `Carta ${cardNumber} registrata con successo! Saldo iniziale: ${formatCurrency(0)}.`, "success");
            } catch (error) {
                console.error("Errore nella registrazione della carta:", error);
                showMessageBox("Errore", "Impossibile registrare la carta.", "error");
            }
            showLoader(false);
        };

        // Admin function: modal for balance modification
        const renderBalanceModal = (cardId, currentBalance, ownerUsername) => {
            if (!isAdmin) return;
            const container = document.getElementById('app-container');
            const existingModal = document.getElementById('balance-modal');
            if (existingModal) existingModal.remove();

            const modalHTML = `
                <div id="balance-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="card max-w-md">
                        <h3 class="text-lg font-bold text-gray-900 border-b pb-3 mb-4">Modifica Saldo Carta</h3>
                        <p class="text-sm text-gray-600 mb-2">Carta: <span class="font-mono font-bold text-indigo-700">${cardId.replace(/(\d{4})/g, '$1 ').trim()}</span></p>
                        <p class="text-sm text-gray-600 mb-4">Proprietario: ${ownerUsername} | Saldo Attuale: <span class="font-bold">${formatCurrency(currentBalance)}</span></p>
                        
                        <label class="block text-sm font-medium text-gray-700 mb-1">Importo da Aggiungere/Sottrarre</label>
                        <input type="number" id="balance_amount" step="0.01" value="0.00" class="w-full p-3 mb-4 border border-gray-300 rounded-lg" required />
                        
                        <div class="flex justify-end space-x-3">
                            <button onclick="document.getElementById('balance-modal').remove()" class="btn-secondary w-auto px-4 py-2">Annulla</button>
                            <button onclick="window.handleAdminCardAction('${cardId}', 'subtract')" class="bg-red-500 hover:bg-red-600 text-white w-auto px-4 py-2 rounded-lg font-semibold">Sottrai</button>
                            <button onclick="window.handleAdminCardAction('${cardId}', 'add')" class="bg-green-500 hover:bg-green-600 text-white w-auto px-4 py-2 rounded-lg font-semibold">Aggiungi</button>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('afterend', modalHTML);
        };
        
        // Admin function: process card actions (add/subtract/delete)
        const handleAdminCardAction = (cardId, action) => {
            if (!isAdmin) return;
            
            if (action === 'delete') {
                showMessageBox("Conferma Eliminazione", `Sei sicuro di voler RIMUOVERE definitivamente la carta ${cardId}?`, 'error', async () => {
                    showLoader(true);
                    try {
                        await deleteDoc(doc(getCardsCollection(), cardId));
                        showMessageBox("Successo", `Carta ${cardId} rimossa con successo.`, "success");
                    } catch (error) {
                        console.error("Errore nell'eliminazione della carta:", error);
                        showMessageBox("Errore", "Impossibile rimuovere la carta.", "error");
                    }
                    showLoader(false);
                });
                document.getElementById('balance-modal')?.remove();
                return;
            }
            
            // Se l'azione è 'add' o 'subtract', prendi l'importo dal modale
            const amountInput = document.getElementById('balance_amount');
            const amount = parseFloat(amountInput.value);
            
            if (isNaN(amount) || amount <= 0) {
                 showMessageBox("Attenzione", "Inserisci un importo valido e positivo per la transazione.", "alert");
                 return;
            }
            
            // MODIFICA: Cerca la carta nello stato globale (se admin) o locale (se utente)
            const allCards = isAdmin ? window.allCards : window.fakeCreditCards;
            const card = allCards.find(c => c.id === cardId);
            
            if (!card) {
                // Se admin, prova a cercare nello stato globale completo
                 const globalCard = (window.allCards || []).find(c => c.id === cardId);
                 if(globalCard) {
                    card = globalCard;
                 } else {
                    showMessageBox("Errore", "Carta non trovata.", "error");
                    document.getElementById('balance-modal')?.remove();
                    return;
                 }
            }
            
            let newBalance = card.balance;
            let transactionType;

            if (action === 'add') {
                newBalance += amount;
                transactionType = 'Aggiunta';
            } else if (action === 'subtract') {
                newBalance -= amount;
                transactionType = 'Sottrazione';
                if (newBalance < 0) {
                    showMessageBox("Attenzione", `L'operazione renderebbe il saldo negativo (${formatCurrency(newBalance)}). Procedi?`, 'alert', () => {
                        updateCardBalance(cardId, newBalance, transactionType, amount);
                    });
                    return;
                }
            }
            
            updateCardBalance(cardId, newBalance, transactionType, amount);
        };
        
        const updateCardBalance = async (cardId, newBalance, transactionType, amount) => {
            document.getElementById('balance-modal')?.remove(); // Chiude il modale
            showLoader(true);
            
            try {
                await updateDoc(doc(getCardsCollection(), cardId), {
                    balance: newBalance,
                    lastUpdate: new Date().toISOString()
                });
                showMessageBox("Successo", `${transactionType} di ${formatCurrency(amount)} eseguita. Nuovo saldo: ${formatCurrency(newBalance)}.`, "success");
            } catch (error) {
                console.error("Errore nell'aggiornamento del saldo:", error);
                showMessageBox("Errore", "Impossibile aggiornare il saldo della carta.", "error");
            }
            showLoader(false);
        }

        // --- REAL-TIME DATA LISTENERS ---

        const startListeningForData = () => {
            if (isAdmin) {
                // 1. All Users
                const qUsers = getAdminUsersCollection();
                onSnapshot(qUsers, (snapshot) => {
                    let users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    users.sort((a, b) => b.totalThumbtacks - a.totalThumbtacks); 
                    window.allUsers = users;
                    if (document.getElementById('content').innerHTML.includes('Dashboard Admin')) {
                         renderAdminDashboard();
                    }
                    if (document.getElementById('content').innerHTML.includes('Gestione Dipendenti')) {
                         renderJobsView(); // Aggiorna la vista lavori se aperta
                    }
                }, (error) => console.error("Errore nel listener Utenti:", error));

                // 2. All Requests
                const qRequests = query(getRequestsCollection(), orderBy("timestamp", "desc"));
                onSnapshot(qRequests, (snapshot) => {
                    window.thumbtackRequests = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    if (document.getElementById('content').innerHTML.includes('Dashboard Admin')) {
                        renderAdminDashboard();
                    }
                }, (error) => console.error("Errore nel listener Richieste:", error));

                // 3. All Cards (Admin)
                const qCards = getCardsCollection();
                onSnapshot(qCards, (snapshot) => {
                    window.allCards = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id })); // SALVA IN allCards
                    window.fakeCreditCards = window.allCards; // Per retrocompatibilità
                    if (document.getElementById('content').innerHTML.includes('Dashboard Admin')) {
                        renderAdminDashboard();
                    }
                }, (error) => console.error("Errore nel listener Carte Admin:", error));
                
                // 4. Job Applications (Admin)
                const qJobs = query(getJobApplicationsCollection(), where("status", "==", "pending"));
                onSnapshot(qJobs, (snapshot) => {
                    window.jobApplications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (document.getElementById('content').innerHTML.includes('Dashboard Admin')) {
                        renderAdminDashboard(); // Per aggiornare il badge
                    }
                    if (document.getElementById('content').innerHTML.includes('Candidature Pendenti')) {
                        renderJobsView(); // Per aggiornare la lista
                    }
                }, (error) => console.error("Errore nel listener Candidature:", error));

                
            } else {
                // Regular user 
                
                // 1. User Profile
                const userProfileRef = doc(getAdminUsersCollection(), currentUserData.username);
                onSnapshot(userProfileRef, (docSnap) => {
                    if (docSnap.exists()) {
                        currentUserData = docSnap.data();
                        if (document.getElementById('content').innerHTML.includes('Puntine Totali')) {
                            renderUserDashboard();
                        }
                        if (document.getElementById('content').innerHTML.includes('Il Tuo Lavoro Attuale')) {
                            renderJobsView(); // Aggiorna la vista lavori se aperta
                        }
                    } else {
                        showMessageBox("Errore", "Il tuo profilo è stato eliminato. Disconnessione forzata.", "error");
                        handleLogout();
                    }
                }, (error) => console.error("Errore nel listener Profilo Utente:", error));

                // 2. User Requests (Recenti)
                const qUserRequests = query(
                    getRequestsCollection(),
                    where("authUid", "==", currentUserId),
                    orderBy("timestamp", "desc"),
                    limit(10)
                ); 

                onSnapshot(qUserRequests, (snapshot) => {
                    window.thumbtackRequests = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    if (document.getElementById('content').innerHTML.includes('Puntine Totali')) {
                        renderUserDashboard();
                    }
                }, (error) => console.error("Errore nel listener Richieste Utente:", error));
                
                // 3. User Cards
                const qUserCards = query(
                    getCardsCollection(),
                    where("ownerUid", "==", currentUserId)
                );
                onSnapshot(qUserCards, (snapshot) => {
                    window.fakeCreditCards = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    if (document.getElementById('content').innerHTML.includes('Puntine Totali')) {
                        renderUserDashboard();
                    }
                }, (error) => console.error("Errore nel listener Carte Utente:", error));
            }
            
            // 4. Calendar Events (Publicly viewable by all)
            const qEvents = query(getEventsCollection(), orderBy("date", "asc")); 
            onSnapshot(qEvents, (snapshot) => {
                window.calendarEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('calendar-container')) {
                    renderCalendarView(window.currentCalendarDate);
                }
            }, (error) => console.error("Errore nel listener Eventi Calendario:", error));
            
            // 5. ePunt Listings (Publicly viewable by all)
            const qListings = query(getEpuntListingsCollection(), where("status", "==", "active"), orderBy("createdAt", "desc"));
            onSnapshot(qListings, (snapshot) => {
                window.epuntListings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Aggiorna la vista solo se l'utente si trova nel mercatino
                if (document.getElementById('epunt-container')) {
                    renderEpuntMarketplace();
                }
            }, (error) => console.error("Errore nel listener ePunt Listings:", error));
        };
        
        // --- REQUESTS AND RANKS LOGIC ---

        const submitThumbtackRequest = async () => {
            const countInput = document.getElementById('thumbtack_count');
            const quantity = parseInt(countInput.value, 10);

            if (isNaN(quantity) || quantity <= 0) {
                showMessageBox("Attenzione", "Inserisci una quantità di puntine valida (maggiore di zero).", "alert");
                return;
            }

            if (window.thumbtackRequests && window.thumbtackRequests.some(r => r.authUid === currentUserId && r.status === 'Pending')) {
                showMessageBox("Attenzione", "Hai già una richiesta in sospeso. Attendi l'approvazione dell'Admin.", "alert");
                return;
            }

            showLoader(true);
            try {
                await addDoc(getRequestsCollection(), {
                    username: currentUserData.username,
                    authUid: currentUserId,
                    quantity: quantity,
                    status: 'Pending',
                    timestamp: new Date().toISOString()
                });
                countInput.value = '1';
                showMessageBox("Richiesta Inviata", `Richiesta di ${quantity} puntine inviata con successo all'Admin!`, "success");
            } catch (error) {
                console.error("Errore nell'invio della richiesta:", error);
                showMessageBox("Errore", "Impossibile inviare la richiesta.", "error");
            }
            showLoader(false);
        };
        
        const processRequest = async (requestId, action, quantity, username) => {
            const requestRef = doc(getRequestsCollection(), requestId);
            
            // 1. Aggiorna lo stato della richiesta
            await updateDoc(requestRef, { status: action === 'Accept' ? 'Confirmed' : 'Rejected' });

            if (action === 'Accept') {
                const userRef = doc(getAdminUsersCollection(), username);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    
                    // 2. Aumenta le puntine totali
                    const newTotal = userData.totalThumbtacks + quantity;
                    await updateDoc(userRef, { totalThumbtacks: newTotal });
                    
                    // 3. NUOVO: Logica Pagamento Infermiere
                    if (userData.job === 'nurse') {
                        const paymentAmount = quantity * (window.NURSE_PAY_PER_THUMBTACK || 10);
                        
                        // Trova la carta dell'infermiere
                        const qUserCards = query(getCardsCollection(), where("ownerUid", "==", userData.authUid), limit(1));
                        const cardsSnap = await getDoc(qUserCards.docs[0]?.ref); // Usa getDoc sulla ref

                        if (cardsSnap.exists()) {
                            const cardData = cardsSnap.data();
                            const cardRef = cardsSnap.ref;
                            const newBalance = (cardData.balance || 0) + paymentAmount;
                            
                            await updateDoc(cardRef, { balance: newBalance });
                            
                            // Invia un messaggio all'Admin che il pagamento è avvenuto
                            showMessageBox("Pagamento Automatico", `Pagamento di ${formatCurrency(paymentAmount)} inviato a ${username} (Infermiere) per ${quantity} puntine.`, "success");
                        } else {
                            // Messaggio all'Admin se l'infermiere non ha carte
                            showMessageBox("Pagamento Fallito", `${username} è un Infermiere ma non ha una carta registrata. Nessun pagamento inviato.`, "alert");
                        }
                    }
                }
            }
        };
        
        const handleRequestAction = (requestId, action, quantity, authUid, username) => {
            const message = action === 'Accept' 
                ? `Sei sicuro di voler ACCETTARE la richiesta di ${quantity} puntine per ${username}?`
                : `Sei sicuro di voler RIFIUTARE la richiesta di ${quantity} puntine per ${username}?`;

            showMessageBox(action === 'Accept' ? "Accetta Richiesta" : "Rifiuta Richiesta", message, 'alert', async () => {
                showLoader(true);
                try {
                    // La funzione 'processRequest' ora gestisce anche il pagamento
                    await processRequest(requestId, action, quantity, username);
                    
                    // Messaggio di successo generico (il pagamento infermiere ha il suo popup)
                    if (action !== 'Accept' || (window.allUsers.find(u => u.username === username)?.job !== 'nurse')) {
                         showMessageBox("Successo", `Richiesta di ${username} ${action === 'Accept' ? 'accettata' : 'rifiutata'} con successo.`, "success");
                    }
                } catch (error) {
                    console.error(`Errore durante l'azione ${action}:`, error);
                    showMessageBox("Errore", "Impossibile processare la richiesta. " + error.message, "error");
                }
                showLoader(false);
            });
        };
        
        const handleRankChange = (username) => {
            if (!isAdmin) return;
            const user = window.allUsers.find(u => u.username === username);
            if (!user) return;

            const currentRankIndex = RANKS.indexOf(user.rank);
            const nextRankIndex = currentRankIndex + 1;

            if (nextRankIndex >= RANKS.length) {
                showMessageBox("Attenzione", `${username} ha già il grado massimo: ${user.rank}.`, "alert");
                return;
            }

            const nextRankName = RANKS[nextRankIndex];

            showMessageBox("Conferma Promozione", `Promuovere ${username} al grado: ${nextRankName}?`, 'info', async () => {
                showLoader(true);
                try {
                    const userRef = doc(getAdminUsersCollection(), username);
                    await updateDoc(userRef, { rank: nextRankName });
                    showMessageBox("Successo", `${username} è stato promosso a ${nextRankName}!`, "success");
                } catch (error) {
                    console.error("Errore nella promozione:", error);
                    showMessageBox("Errore", "Impossibile aggiornare il grado.", "error");
                }
                showLoader(false);
            });
        };

        // --- CALENDAR LOGIC AND UI ---
        
        const generateCalendarHtml = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth(); 
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

            const daysOfWeek = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const startDayOfWeek = firstDayOfMonth.getDay(); 

            const monthString = year + '-' + String(month + 1).padStart(2, '0');
            const monthlyEvents = (window.calendarEvents || []).filter(event => 
                event.date && event.date.startsWith(monthString)
            );

            const eventsMap = monthlyEvents.reduce((acc, event) => {
                const day = parseInt(event.date.substring(8, 10), 10);
                if (!acc[day]) acc[day] = [];
                acc[day].push(event);
                return acc;
            }, {});

            let calendarGrid = '';
            let day = 1;

            for (let i = 0; i < startDayOfWeek; i++) {
                calendarGrid += `<div class="p-2 border border-gray-100 bg-gray-50/50 text-gray-400"></div>`;
            }

            while (day <= daysInMonth) {
                const dateString = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                const isToday = isCurrentMonth && day === today.getDate();
                const dayEvents = eventsMap[day] || [];

                const dayClasses = `p-2 border border-gray-200 h-24 sm:h-32 relative transition-colors cursor-default ${isToday ? 'bg-indigo-100 border-indigo-400 font-bold' : 'bg-white hover:bg-gray-50'}`;

                let eventHtml = '';
                if (dayEvents.length > 0) {
                    // MODIFICA: Aggiunto onclick
                    eventHtml = dayEvents.map(event => `
                        <div class="mt-1 text-xs truncate bg-red-500 text-white rounded px-1.5 py-0.5 calendar-event" 
                             title="${event.title}"
                             onclick="window.showEventDetails('${event.id}')">
                            ${event.title}
                        </div>
                    `).join('');
                }

                calendarGrid += `
                    <div class="${dayClasses}">
                        <div class="text-right text-sm">${day}</div>
                        ${eventHtml}
                    </div>
                `;
                day++;
            }

            const monthYearString = date.toLocaleDateString('it-IT', { year: 'numeric', month: 'long' });
            
            const headerHtml = `
                <div class="flex justify-between items-center mb-4 p-4 bg-indigo-50 rounded-t-xl">
                    <button onclick="window.navigateCalendar(-1)" class="btn-secondary px-3 py-1 text-sm">&lt; Precedente</button>
                    <h2 class="text-xl font-bold text-indigo-800">${monthYearString.charAt(0).toUpperCase() + monthYearString.slice(1)}</h2>
                    <button onclick="window.navigateCalendar(1)" class="btn-secondary px-3 py-1 text-sm">Successivo &gt;</button>
                </div>
            `;

            const bodyHtml = `
                <div class="grid grid-cols-7 text-center font-semibold text-gray-700 border-t border-b border-gray-300">
                    ${daysOfWeek.map(day => `<div class="p-2 text-sm">${day}</div>`).join('')}
                </div>
                <div class="grid grid-cols-7" id="calendar-grid">
                    ${calendarGrid}
                </div>
            `;

            return headerHtml + bodyHtml;
        };
        
        // NUOVA FUNZIONE: Mostra dettagli evento
        const showEventDetails = (eventId) => {
            const event = window.calendarEvents.find(e => e.id === eventId);
            if (!event) {
                showMessageBox("Errore", "Evento non trovato.", "error");
                return;
            }
            
            const message = `
                <p class="text-sm text-gray-500 mb-2">Data: ${new Date(event.date + 'T00:00:00').toLocaleDateString()}</p>
                <p class="text-gray-700">${event.description || 'Nessuna descrizione.'}</p>
            `;
            showMessageBox(event.title, message, 'info');
        };

        const navigateCalendar = (offset) => {
            const newDate = new Date(window.currentCalendarDate);
            newDate.setMonth(newDate.getMonth() + offset);
            renderCalendarView(newDate);
        };
        
        const handleBackToDashboard = () => {
            if (isAdmin) {
                renderAdminDashboard();
            } else {
                renderUserDashboard();
            }
        }
        
        const renderCalendarView = (date = window.currentCalendarDate) => {
            window.currentCalendarDate = date; 
            
            const adminControls = isAdmin ? `
                <div class="mb-6 p-4 border border-indigo-300 bg-indigo-50 rounded-xl flex justify-between items-center">
                    <p class="text-indigo-700 font-medium">Gestione Eventi (Admin)</p>
                    <button onclick="window.renderEventModal()" class="btn-primary flex items-center w-auto px-4 py-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Aggiungi Evento
                    </button>
                </div>
            ` : '';
            
            const backButton = `
                <div class="mb-4">
                    <button onclick="window.handleBackToDashboard()" class="text-sm text-indigo-500 hover:text-indigo-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Torna alla Dashboard
                    </button>
                </div>
            `;

            const html = `
                <div id="calendar-container" class="w-full">
                    ${backButton}
                    <h1 class="text-3xl header text-center">Calendario Eventi</h1>
                    ${adminControls}
                    <div class="calendar-box border border-gray-300 rounded-xl overflow-hidden shadow-xl">
                        ${generateCalendarHtml(date)}
                    </div>
                </div>
            `;
            showView(html);
        };
        
        const renderEventModal = (date = null) => {
            if (!isAdmin) return;
            const container = document.getElementById('app-container');
            const existingModal = document.getElementById('event-modal');
            if (existingModal) existingModal.remove();

            const todayString = new Date().toISOString().substring(0, 10);
            const initialDate = date ? date.toISOString().substring(0, 10) : todayString;

            const modalHTML = `
                <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="card max-w-md">
                        <h3 class="text-lg font-bold text-gray-900 border-b pb-3 mb-4">Aggiungi Nuovo Evento</h3>
                        
                        <label class="block text-sm font-medium text-gray-700 mb-1">Titolo Evento</label>
                        <input type="text" id="event_title" placeholder="Riunione, Scadenza, Fiera..." class="w-full p-3 mb-4 border border-gray-300 rounded-lg" required />
                        
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                        <input type="date" id="event_date" value="${initialDate}" class="w-full p-3 mb-4 border border-gray-300 rounded-lg" required />

                        <label class="block text-sm font-medium text-gray-700 mb-1">Descrizione (facoltativa)</label>
                        <textarea id="event_description" placeholder="Dettagli dell'evento..." class="w-full p-3 mb-6 border border-gray-300 rounded-lg"></textarea>
                        
                        <div class="flex justify-end space-x-3">
                            <button onclick="document.getElementById('event-modal').remove()" class="btn-secondary w-auto px-4 py-2">Annulla</button>
                            <button onclick="window.submitNewEvent()" class="btn-primary w-auto px-4 py-2">Salva Evento</button>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('afterend', modalHTML);
        };

        const submitNewEvent = async () => {
            if (!isAdmin) return;
            const title = document.getElementById('event_title').value.trim();
            const date = document.getElementById('event_date').value;
            const description = document.getElementById('event_description').value.trim();

            if (!title || !date) {
                showMessageBox("Attenzione", "Inserisci il titolo e la data dell'evento.", "alert");
                return;
            }

            document.getElementById('event-modal').remove(); 
            showLoader(true);
            
            try {
                await addDoc(getEventsCollection(), {
                    title: title,
                    date: date, 
                    description: description,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUserData.username
                });
                showMessageBox("Successo", `L'evento '${title}' è stato aggiunto al calendario.`, "success");
            } catch (error) {
                console.error("Errore nell'aggiunta dell'evento:", error);
                showMessageBox("Errore", "Impossibile salvare l'evento.", "error");
            }
            showLoader(false);
        };
        
        // --- EPUNT MARKETPLACE LOGIC AND UI ---

        const renderEpuntMarketplace = () => {
            const listings = window.epuntListings || [];
            // Filtra solo gli annunci attivi (anche se il listener dovrebbe già farlo)
            const activeListings = listings.filter(l => l.status === 'active');
            const userListings = activeListings.filter(l => l.sellerUid === currentUserId);
            const otherListings = activeListings.filter(l => l.sellerUid !== currentUserId);
            const userHasCard = window.fakeCreditCards && window.fakeCreditCards.length > 0;

            const backButton = `
                <div class="mb-4">
                    <button onclick="window.handleBackToDashboard()" class="text-sm text-indigo-500 hover:text-indigo-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Torna alla Dashboard
                    </button>
                </div>
            `;
            
            let sellButtonHtml = `
                <button onclick="window.renderCreateListingForm()" class="btn-primary bg-green-600 hover:bg-green-700 flex items-center w-auto px-4 py-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v2h2a1 1 0 110 2h-2v2a1 1 0 11-2 0V8H7a1 1 0 110-2h2V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Vendi un Oggetto
                </button>
            `;
            
            if (!userHasCard) {
                sellButtonHtml = `
                    <div class="p-3 bg-yellow-100 border border-yellow-300 rounded-lg text-yellow-800 text-sm">
                        Per vendere o acquistare oggetti, devi prima <button onclick="window.handleBackToDashboard()" class="font-bold underline">registrare una carta</button> nella tua dashboard.
                    </div>
                `;
            }

            const renderListingCard = (item, isOwnListing = false) => {
                return `
                    <div class="border rounded-lg p-4 shadow-sm bg-white flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-lg font-bold text-gray-900">${item.name}</h4>
                                <span class="font-bold text-xl text-green-600">${formatCurrency(item.price)}</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">${item.description || 'Nessuna descrizione.'}</p>
                            <p class="text-xs text-gray-400">Venditore: ${item.sellerUsername}</p>
                        </div>
                        <div class="mt-4">
                            ${isOwnListing ? 
                                `<button onclick="window.handleDeleteListing('${item.id}')" class="btn-secondary w-full bg-red-100 text-red-700 hover:bg-red-200">Ritira dalla Vendita</button>` 
                                : 
                                (userHasCard ? 
                                    `<button onclick="window.handlePurchaseItem('${item.id}')" class="btn-primary w-full">Acquista Ora</button>` 
                                    : 
                                    `<button class="btn-primary w-full opacity-50 cursor-not-allowed" disabled title="Registra una carta per acquistare">Acquista Ora</button>`)
                            }
                        </div>
                    </div>
                `;
            };

            const html = `
                <div id="epunt-container" class="w-full">
                    ${backButton}
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl header text-left mb-0">🛒 Mercatino ePunt</h1>
                        ${sellButtonHtml}
                    </div>

                    <h2 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">In Vendita</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                        ${otherListings.length > 0 ? 
                            otherListings.map(item => renderListingCard(item, false)).join('') 
                            : 
                            '<p class="text-gray-500 md:col-span-2 lg:col-span-3">Nessun oggetto in vendita al momento.</p>'
                        }
                    </div>

                    ${userHasCard ? `
                    <h2 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">I Tuoi Oggetti in Vendita</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${userListings.length > 0 ? 
                            userListings.map(item => renderListingCard(item, true)).join('') 
                            : 
                            '<p class="text-gray-500 md:col-span-2 lg:col-span-3">Non hai nessun oggetto in vendita.</p>'
                        }
                    </div>
                    ` : ''}
                </div>
            `;
            showView(html);
        };
        
        const renderCreateListingForm = () => {
            const userCard = window.fakeCreditCards[0]; // Assumiamo la prima carta
            if (!userCard) {
                showMessageBox("Errore", "Devi avere una carta registrata per vendere.", "error", renderEpuntMarketplace);
                return;
            }
            
            const html = `
                <div id="epunt-create-form" class="w-full">
                    <div class="mb-4">
                        <button onclick="window.renderEpuntMarketplace()" class="text-sm text-indigo-500 hover:text-indigo-700 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                            Annulla
                        </button>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800 mb-4">Metti in Vendita un Oggetto</h1>
                    
                    <div class="card bg-gray-50 p-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome Oggetto</label>
                        <input type="text" id="item_name" placeholder="Es. Puntina d'Oro" class="w-full p-3 mb-4 border border-gray-300 rounded-lg" required />
                        
                        <label class="block text-sm font-medium text-gray-700 mb-1">Prezzo (EUR)</label>
                        <input type="number" id="item_price" step="0.01" min="0.01" value="1.00" class="w-full p-3 mb-4 border border-gray-300 rounded-lg" required />

                        <label class="block text-sm font-medium text-gray-700 mb-1">Descrizione (facoltativa)</label>
                        <textarea id="item_description" placeholder="Dettagli dell'oggetto..." class="w-full p-3 mb-6 border border-gray-300 rounded-lg"></textarea>
                        
                        <div class="p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-indigo-800 text-sm mb-6">
                            I fondi della vendita saranno accreditati sulla tua prima carta registrata:
                            <strong class="font-mono">${userCard.id.replace(/(\d{4})/g, '$1 ').trim()}</strong>
                        </div>
                        
                        <button onclick="window.submitNewListing()" class="btn-primary w-full">Metti in Vendita</button>
                    </div>
                </div>
            `;
            showView(html);
        };
        
        const submitNewListing = async () => {
            const name = document.getElementById('item_name').value.trim();
            const price = parseFloat(document.getElementById('item_price').value);
            const description = document.getElementById('item_description').value.trim();
            
            const userCard = window.fakeCreditCards[0]; // Assumiamo la prima carta

            if (!name || isNaN(price) || price <= 0) {
                showMessageBox("Attenzione", "Inserisci un nome valido e un prezzo (maggiore di zero).", "alert");
                return;
            }
            
            if (!userCard) {
                // Questo non dovrebbe succedere se la UI ha funzionato, ma è un check di sicurezza
                showMessageBox("Errore", "Nessuna carta trovata per la vendita.", "error");
                return;
            }

            showLoader(true);
            try {
                await addDoc(getEpuntListingsCollection(), {
                    name: name,
                    description: description,
                    price: price,
                    status: 'active',
                    sellerUsername: currentUserData.username,
                    sellerUid: currentUserId,
                    sellerCardId: userCard.id, // Salviamo la carta su cui accreditare
                    createdAt: new Date().toISOString()
                });
                showMessageBox("Successo", `'${name}' è ora in vendita nel mercatino!`, "success", () => {
                    renderEpuntMarketplace();
                });
            } catch (error) {
                console.error("Errore nella creazione dell'annuncio:", error);
                showMessageBox("Errore", "Impossibile creare l'annuncio.", "error");
            }
            showLoader(false);
        };
        
        const handleDeleteListing = (listingId) => {
            if (!listingId) return;
            const item = (window.epuntListings || []).find(l => l.id === listingId);
            if (!item || item.sellerUid !== currentUserId) {
                 showMessageBox("Errore", "Non puoi rimuovere questo oggetto.", "error");
                 return;
            }
            
            showMessageBox("Conferma Rimozione", `Vuoi ritirare '${item.name}' dalla vendita?`, 'alert', async () => {
                showLoader(true);
                try {
                    // Usiamo deleteDoc per rimuovere l'annuncio
                    await deleteDoc(doc(getEpuntListingsCollection(), listingId));
                    showMessageBox("Successo", "Oggetto rimosso dalla vendita.", "success");
                    // Il listener aggiornerà la UI
                } catch (error) {
                    console.error("Errore nella rimozione dell'annuncio:", error);
                    showMessageBox("Errore", "Impossibile rimuovere l'annuncio.", "error");
                }
                showLoader(false);
            });
        };
        
        const handlePurchaseItem = (listingId) => {
            if (!listingId) return;
            const item = (window.epuntListings || []).find(l => l.id === listingId);
            if (!item) {
                 showMessageBox("Errore", "Oggetto non più disponibile.", "error");
                 return;
            }
            
            // LOGICA BANCHIERE: Bloccata
            // if(true) { // Qui andrebbe la logica per verificare se un banchiere è attivo
            //     showMessageBox("Funzione Bloccata", "Le transazioni sono attualmente gestite da un Banchiere e devono essere approvate. Questa funzione non è ancora implementata.", "alert");
            //     return;
            // }

            const buyerCard = window.fakeCreditCards[0]; // Assumiamo la prima carta
            
            if (!buyerCard) {
                showMessageBox("Errore", "Devi avere una carta registrata per acquistare.", "error");
                return;
            }
            if (buyerCard.balance < item.price) {
                showMessageBox("Saldo Insufficiente", `La tua carta (${buyerCard.id.replace(/(\d{4})/g, '$1 ').trim()}) ha solo ${formatCurrency(buyerCard.balance)}. Saldo richiesto: ${formatCurrency(item.price)}.`, "error");
                return;
            }

            const confirmMessage = `
                <p>Vuoi acquistare <strong>'${item.name}'</strong> per <strong>${formatCurrency(item.price)}</strong>?</p>
                <p class="text-sm mt-3">L'importo sarà addebitato sulla tua carta: <br><strong class="font-mono">${buyerCard.id.replace(/(\d{4})/g, '$1 ').trim()}</strong></p>
            `;

            showMessageBox("Conferma Acquisto", confirmMessage, 'alert', async () => {
                showLoader(true);
                try {
                    const buyerCardRef = doc(getCardsCollection(), buyerCard.id);
                    const sellerCardRef = doc(getCardsCollection(), item.sellerCardId);
                    const listingRef = doc(getEpuntListingsCollection(), item.id);
                    
                    // 1. Leggi il saldo del venditore (è necessario perché non lo abbiamo in tempo reale)
                    const sellerCardSnap = await getDoc(sellerCardRef);
                    if (!sellerCardSnap.exists()) {
                        throw new Error(`La carta del venditore (${item.sellerCardId}) non è stata trovata.`);
                    }
                    
                    const sellerCardData = sellerCardSnap.data();
                    
                    // Calcola i nuovi saldi
                    const buyerNewBalance = buyerCard.balance - item.price;
                    const sellerNewBalance = sellerCardData.balance + item.price;
                    
                    // 2. Aggiorna il saldo del compratore
                    await updateDoc(buyerCardRef, { balance: buyerNewBalance });
                    
                    // 3. Aggiorna il saldo del venditore
                    await updateDoc(sellerCardRef, { balance: sellerNewBalance });
                    
                    // 4. Aggiorna l'annuncio a 'sold'
                    await updateDoc(listingRef, { 
                        status: 'sold', 
                        buyerUsername: currentUserData.username, 
                        buyerUid: currentUserId, 
                        soldAt: new Date().toISOString() 
                    });

                    showMessageBox("Acquisto Riuscito!", `Hai acquistato '${item.name}'!`, "success");
                    // Il listener aggiornerà la UI rimuovendo l'oggetto (perché non più 'active')
                    
                } catch (error) {
                    console.error("Errore durante la transazione:", error);
                    showMessageBox("Errore di Transazione", "Impossibile completare l'acquisto. L'oggetto potrebbe non essere più disponibile o la carta del venditore rimossa. (" + error.message + ")", "error");
                }
                showLoader(false);
            });
        };
        
        // --- NUOVA SEZIONE: GESTIONE LAVORI (Jobs) ---
        
        const renderJobsView = () => {
            const backButton = `
                <div class="mb-4">
                    <button onclick="window.handleBackToDashboard()" class="text-sm text-indigo-500 hover:text-indigo-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Torna alla Dashboard
                    </button>
                </div>
            `;
            
            let html = `
                <div id="jobs-container" class="w-full">
                    ${backButton}
                    <h1 class="text-3xl header text-left mb-6">💼 Gestione Lavori</h1>
                    ${isAdmin ? renderAdminJobsView() : renderUserJobsView()}
                </div>
            `;
            showView(html);
        };
        
        // --- VISTA LAVORI PER UTENTE ---
        const renderUserJobsView = () => {
            const { job, quitCount } = currentUserData;
            
            if (job) {
                // L'utente ha un lavoro
                const jobName = window.AVAILABLE_JOBS[job] || job;
                let jobActionsHtml = '';
                
                // Azioni specifiche per lavoro (segnaposto)
                if (job === 'banker') {
                    jobActionsHtml = `<button onclick="window.showNotImplemented()" class="btn-primary w-full mt-4">Approva Transazioni (Non implementato)</button>`;
                } else if (job === 'musician') {
                    jobActionsHtml = `<button onclick="window.showNotImplemented()" class="btn-primary w-full mt-4">Carica MP3 (Non implementato)</button>`;
                } else if (job === 'gamedev') {
                    jobActionsHtml = `<button onclick="window.showNotImplemented()" class="btn-primary w-full mt-4">Carica Gioco (Non implementato)</button>`;
                } else if (job === 'nurse') {
                    jobActionsHtml = `<div class="p-3 bg-green-50 text-green-800 rounded-lg mt-4 text-sm">Il tuo stipendio viene pagato automaticamente (${formatCurrency(window.NURSE_PAY_PER_THUMBTACK)} per puntina) quando l'Admin approva le tue richieste.</div>`;
                }
                
                return `
                    <h2 class="text-xl font-bold text-gray-800 mb-4" id="job-status-header">Il Tuo Lavoro Attuale</h2>
                    <div class="p-6 border rounded-lg bg-indigo-50">
                        <p class="text-lg text-indigo-800">Sei impiegato come: <strong class="text-2xl">${jobName}</strong></p>
                        ${jobActionsHtml}
                        <hr class="my-6 border-indigo-200">
                        <p class="text-sm text-gray-600 mb-4">Se ti licenzi, conterà come una delle tue ${3 - quitCount} dimissioni rimaste.</p>
                        <button onclick="window.handleQuitJob()" class="btn-secondary w-full bg-red-100 text-red-700 hover:bg-red-200">Licenziati</button>
                    </div>
                `;
            } else {
                // L'utente è disoccupato
                if (quitCount >= 3) {
                    return `
                        <h2 class="text-xl font-bold text-gray-800 mb-4" id="job-status-header">Cerca Lavoro</h2>
                        <div class="p-6 border rounded-lg bg-red-50 text-red-800">
                            <p class="font-bold">Hai esaurito i tuoi tentativi.</p>
                            <p>Ti sei licenziato ${quitCount} volte (massimo 3) e non puoi più candidarti per un lavoro.</p>
                        </div>
                    `;
                }
                
                // Mostra lista lavori
                const jobListHtml = Object.keys(window.AVAILABLE_JOBS).map(jobId => {
                    const jobName = window.AVAILABLE_JOBS[jobId];
                    return `
                        <div class="list-item">
                            <span class="font-semibold">${jobName}</span>
                            <button onclick="window.handleApplyForJob('${jobId}')" class="btn-primary w-auto px-4 py-2 text-sm">Candidati</button>
                        </div>
                    `;
                }).join('');
                
                return `
                    <h2 class="text-xl font-bold text-gray-800 mb-4" id="job-status-header">Cerca Lavoro</h2>
                    <p class="text-gray-600 mb-4">Sei disoccupato. Puoi candidarti per una posizione. Hai ${3 - quitCount} dimissioni rimaste.</p>
                    <div class="border rounded-lg overflow-hidden">
                        ${jobListHtml}
                    </div>
                `;
            }
        };
        
        // --- VISTA LAVORI PER ADMIN ---
        const renderAdminJobsView = () => {
            const applications = window.jobApplications || [];
            const employees = (window.allUsers || []).filter(u => u.job);

            const applicationsHtml = applications.length > 0 ? applications.map(app => {
                const jobName = window.AVAILABLE_JOBS[app.jobId] || app.jobId;
                return `
                    <div class="list-item bg-yellow-50">
                        <div class="flex-1">
                            <p><strong class="font-semibold">${app.username}</strong> si candida per <strong>${jobName}</strong></p>
                            <p class="text-xs text-gray-500">Data: ${new Date(app.timestamp).toLocaleDateString()}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="window.showUserInfractions('${app.username}', '${app.id}', '${app.jobId}')" class="btn-secondary w-auto px-3 py-1 text-xs bg-blue-100 hover:bg-blue-200 text-blue-800">Vedi Foglio</button>
                            <button onclick="window.handleJobApplication('${app.id}', 'reject', '${app.username}', '${app.jobId}')" class="btn-secondary w-auto px-3 py-1 text-xs bg-red-100 hover:bg-red-200 text-red-700">Rifiuta</button>
                            <button onclick="window.handleJobApplication('${app.id}', 'approve', '${app.username}', '${app.jobId}')" class="btn-secondary w-auto px-3 py-1 text-xs bg-green-100 hover:bg-green-200 text-green-700">Approva</button>
                        </div>
                    </div>
                `;
            }).join('') : '<p class="text-gray-500 p-4">Nessuna candidatura pendente.</p>';
            
            const employeesHtml = employees.length > 0 ? employees.map(user => {
                 const jobName = window.AVAILABLE_JOBS[user.job] || user.job;
                 return `
                    <div class="list-item">
                        <div class="flex-1">
                            <p><strong class="font-semibold">${user.username}</strong> - ${jobName}</p>
                            <p class="text-xs text-gray-500">Dimissioni usate: ${user.quitCount || 0}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="window.renderInfractionModal('${user.username}')" class="btn-secondary w-auto px-3 py-1 text-xs bg-yellow-100 hover:bg-yellow-200 text-yellow-800">Nota Demerito</button>
                            <button onclick="window.handleFireUser('${user.username}')" class="btn-secondary w-auto px-3 py-1 text-xs bg-red-100 hover:bg-red-200 text-red-700">Licenzia</button>
                        </div>
                    </div>
                 `;
            }).join('') : '<p class="text-gray-500 p-4">Nessun dipendente attivo.</p>';

            return `
                <div class="flex border-b mb-4">
                    <span id="tab-applications" class="tab active" onclick="window.switchJobTab('applications')">Candidature Pendenti (${applications.length})</span>
                    <span id="tab-employees" class="tab" onclick="window.switchJobTab('employees')">Gestione Dipendenti (${employees.length})</span>
                </div>
                
                <div id="content-applications">
                    <div class="border rounded-lg overflow-hidden">${applicationsHtml}</div>
                </div>
                
                <div id="content-employees" class="hidden">
                    <div class="border rounded-lg overflow-hidden">${employeesHtml}</div>
                </div>
            `;
        };
        
        const switchJobTab = (tabName) => {
            if (tabName === 'applications') {
                document.getElementById('content-applications').classList.remove('hidden');
                document.getElementById('content-employees').classList.add('hidden');
                document.getElementById('tab-applications').classList.add('active');
                document.getElementById('tab-employees').classList.remove('active');
            } else {
                document.getElementById('content-applications').classList.add('hidden');
                document.getElementById('content-employees').classList.remove('hidden');
                document.getElementById('tab-applications').classList.remove('active');
                document.getElementById('tab-employees').classList.add('active');
            }
        };

        const showNotImplemented = () => {
            showMessageBox("Funzione non disponibile", "Questa funzionalità (Musica, Giochi, Banchiere) è complessa e richiede un backend (Firebase Functions) e (Firebase Storage) per funzionare. Non è implementata.", "alert");
        };

        // --- Funzioni Logiche per Lavori ---
        
        const handleApplyForJob = async (jobId) => {
            if (currentUserData.quitCount >= 3) {
                 showMessageBox("Errore", "Hai esaurito i tuoi tentativi di candidatura.", "error");
                 return;
            }
            
            // Controlla se ha già una candidatura
            const q = query(getJobApplicationsCollection(), where("username", "==", currentUserData.username), where("status", "==", "pending"));
            const existingApp = await getDoc(q.docs[0]?.ref);
            if (existingApp.exists()) {
                showMessageBox("Attenzione", "Hai già una candidatura in sospeso. Attendi la risposta dell'Admin.", "alert");
                return;
            }

            const jobName = window.AVAILABLE_JOBS[jobId] || jobId;
            showMessageBox("Conferma Candidatura", `Vuoi candidarti per ${jobName}?`, "info", async () => {
                showLoader(true);
                try {
                    await addDoc(getJobApplicationsCollection(), {
                        username: currentUserData.username,
                        authUid: currentUserId,
                        jobId: jobId,
                        status: 'pending',
                        timestamp: new Date().toISOString()
                    });
                    showMessageBox("Successo", "Candidatura inviata! L'Admin la esaminerà.", "success");
                } catch (error) {
                    console.error("Errore candidatura:", error);
                    showMessageBox("Errore", "Impossibile inviare la candidatura.", "error");
                }
                showLoader(false);
            });
        };
        
        const handleQuitJob = () => {
             const { job, quitCount } = currentUserData;
             if (!job) return;
             
             const jobName = window.AVAILABLE_JOBS[job] || job;
             const newQuitCount = quitCount + 1;
             
             showMessageBox("Conferma Dimissioni", `Sei sicuro di volerti licenziare da ${jobName}? Userai 1 delle tue 3 dimissioni. (Tentativi rimasti: ${3 - quitCount})`, "alert", async () => {
                showLoader(true);
                 try {
                    const userRef = doc(getAdminUsersCollection(), currentUserData.username);
                    await updateDoc(userRef, {
                        job: null,
                        quitCount: newQuitCount
                    });
                    showMessageBox("Successo", "Ti sei licenziato. Ora sei disoccupato.", "success");
                    // Il listener aggiornerà la UI
                 } catch (error) {
                    console.error("Errore dimissioni:", error);
                    showMessageBox("Errore", "Impossibile elaborare le dimissioni.", "error");
                 }
                 showLoader(false);
             });
        };
        
        const handleJobApplication = async (appId, action, username, jobId) => {
            if (!isAdmin) return;
            const appRef = doc(getJobApplicationsCollection(), appId);
            const userRef = doc(getAdminUsersCollection(), username);
            
            showLoader(true);
            try {
                if (action === 'approve') {
                    await updateDoc(userRef, { job: jobId });
                    await deleteDoc(appRef); // Rimuove la candidatura
                    showMessageBox("Successo", `${username} è stato assunto come ${window.AVAILABLE_JOBS[jobId]}.`, "success");
                } else {
                    // Rifiuta
                    await updateDoc(appRef, { status: 'rejected' }); // O deleteDoc(appRef)
                    await deleteDoc(appRef); // Rimuoviamola
                    showMessageBox("Successo", `Candidatura di ${username} rifiutata.`, "success");
                }
            } catch (error) {
                console.error("Errore gestione candidatura:", error);
                showMessageBox("Errore", "Impossibile processare la candidatura.", "error");
            }
            showLoader(false);
        };
        
        const handleFireUser = (username) => {
            if (!isAdmin) return;
            
            showMessageBox("Conferma Licenziamento", `Sei sicuro di voler licenziare ${username}? Questa azione non conta nel loro limite di dimissioni.`, "alert", async () => {
                showLoader(true);
                try {
                    const userRef = doc(getAdminUsersCollection(), username);
                    await updateDoc(userRef, { job: null });
                    showMessageBox("Successo", `${username} è stato licenziato.`, "success");
                } catch (error) {
                    console.error("Errore licenziamento:", error);
                    showMessageBox("Errore", "Impossibile licenziare l'utente.", "error");
                }
                showLoader(false);
            });
        };
        
        // --- Funzioni Logica Infrazioni ("Foglio") ---
        
        const renderInfractionModal = (username) => {
            if (!isAdmin) return;
            const container = document.getElementById('app-container');
            const existingModal = document.getElementById('infraction-modal');
            if (existingModal) existingModal.remove();

            const modalHTML = `
                <div id="infraction-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="card max-w-md">
                        <h3 class="text-lg font-bold text-gray-900 border-b pb-3 mb-4">Aggiungi Nota di Demerito</h3>
                        <p class="text-sm text-gray-600 mb-4">Stai aggiungendo una nota per: <strong class="font-semibold">${username}</strong></p>
                        
                        <label class="block text-sm font-medium text-gray-700 mb-1">Dettagli Infrazione/Errore</label>
                        <textarea id="infraction_details" placeholder="Es. Ha sbagliato un pagamento, è stato scortese, ecc." class="w-full p-3 mb-6 border border-gray-300 rounded-lg h-32"></textarea>
                        
                        <div class="flex justify-end space-x-3">
                            <button onclick="document.getElementById('infraction-modal').remove()" class="btn-secondary w-auto px-4 py-2">Annulla</button>
                            <button onclick="window.submitInfraction('${username}')" class="btn-primary w-auto px-4 py-2 bg-red-600 hover:bg-red-700">Registra Nota</button>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('afterend', modalHTML);
        };
        
        const submitInfraction = async (username) => {
            if (!isAdmin) return;
            const details = document.getElementById('infraction_details').value.trim();
            if (!details) {
                showMessageBox("Attenzione", "Inserisci i dettagli della nota di demerito.", "alert");
                return;
            }
            
            document.getElementById('infraction-modal').remove();
            showLoader(true);
            
            try {
                await addDoc(getUserInfractionsCollection(username), {
                    details: details,
                    timestamp: new Date().toISOString(),
                    recordedBy: currentUserData.username
                });
                showMessageBox("Successo", `Nota di demerito registrata per ${username}.`, "success");
            } catch (error) {
                 console.error("Errore registrazione nota:", error);
                 showMessageBox("Errore", "Impossibile registrare la nota.", "error");
            }
            showLoader(false);
        };
        
        const showUserInfractions = async (username, appId = null, jobId = null) => {
            if (!isAdmin) return;
            showLoader(true);
            
            let infractionsHtml = '<p class="text-gray-500">Nessuna nota di demerito trovata.</p>';
            
            try {
                const q = query(getUserInfractionsCollection(username), orderBy("timestamp", "desc"));
                const snapshot = await getDocs(q); // Usa getDocs per una lettura singola
                
                if (!snapshot.empty) {
                    infractionsHtml = snapshot.docs.map((doc, index) => {
                        const data = doc.data();
                        return `
                            <div class="list-item ${index % 2 === 0 ? 'bg-gray-50' : ''}">
                                <div class="flex-1">
                                    <p class="text-gray-800">${data.details}</p>
                                    <p class="text-xs text-gray-500">Registrato da: ${data.recordedBy} il ${new Date(data.timestamp).toLocaleDateString()}</p>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Modale speciale che include i pulsanti di assunzione
                const container = document.getElementById('app-container');
                const existingModal = document.getElementById('custom-modal');
                if (existingModal) existingModal.remove();

                const jobName = window.AVAILABLE_JOBS[jobId] || jobId;
                const modalHTML = `
                    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div class="card max-w-lg">
                            <h3 class="text-lg font-bold text-gray-900 border-b pb-3 mb-4">Foglio di Valutazione: ${username}</h3>
                            <p class="text-sm text-gray-600 mb-4">Candidatura per: <strong>${jobName}</strong></p>
                            
                            <div class="border rounded-lg overflow-hidden max-h-64 overflow-y-auto mb-6">
                                ${infractionsHtml}
                            </div>
                            
                            <p class="text-sm font-semibold text-gray-700 mb-3">Decisione Candidatura:</p>
                            <div class="flex justify-end space-x-3">
                                <button onclick="document.getElementById('custom-modal').remove()" class="btn-secondary w-auto px-4 py-2">Chiudi</button>
                                <button onclick="window.handleJobApplication('${appId}', 'reject', '${username}', '${jobId}'); document.getElementById('custom-modal').remove();" class="w-auto px-4 py-2 rounded-lg font-semibold bg-red-500 hover:bg-red-600 text-white">Rifiuta</button>
                                <button onclick="window.handleJobApplication('${appId}', 'approve', '${username}', '${jobId}'); document.getElementById('custom-modal').remove();" class="w-auto px-4 py-2 rounded-lg font-semibold bg-green-500 hover:bg-green-600 text-white">Approva</button>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('afterend', modalHTML);

            } catch (error) {
                console.error("Errore lettura foglio:", error);
                showMessageBox("Errore", "Impossibile recuperare il foglio di valutazione.", "error");
            }
            showLoader(false);
        };



        // --- MAIN APPLICATION FLOW ---

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;

                if (currentUserData) {
                    // Logica già gestita da handleSignIn o da listeners
                } else {
                    showLoader(false);
                    renderWelcomeScreen();
                }
            } else {
                showLoader(false);
                renderWelcomeScreen();
            }
        });

        initializeAuth();
        
        // --- ESPOSIZIONE DELLE FUNZIONI GLOBALI (CRITICO PER IL FUNZIONAMENTO DEI PULSANTI) ---
        window.handleLogout = handleLogout;
        window.handleLoginClick = handleLoginClick;
        window.submitThumbtackRequest = submitThumbtackRequest;
        window.handleRankChange = handleRankChange;
        window.handleRequestAction = handleRequestAction;
        window.handleAdminPasswordChange = handleAdminPasswordChange;
        
        // CALENDAR FUNCTIONS
        window.renderCalendarView = renderCalendarView;
        window.navigateCalendar = navigateCalendar;
        window.renderEventModal = renderEventModal;
        window.submitNewEvent = submitNewEvent;
        window.handleBackToDashboard = handleBackToDashboard;
        window.showEventDetails = showEventDetails; // NUOVA
        
        // CARD FUNCTIONS
        window.registerNewCard = registerNewCard;
        window.renderBalanceModal = renderBalanceModal;
        window.handleAdminCardAction = handleAdminCardAction;
        
        // EPUNT FUNCTIONS
        window.renderEpuntMarketplace = renderEpuntMarketplace;
        window.renderCreateListingForm = renderCreateListingForm;
        window.submitNewListing = submitNewListing;
        window.handleDeleteListing = handleDeleteListing;
        window.handlePurchaseItem = handlePurchaseItem;
        
        // JOB FUNCTIONS (NUOVE)
        window.renderJobsView = renderJobsView;
        window.renderAdminJobsView = renderAdminJobsView;
        window.renderUserJobsView = renderUserJobsView;
        window.showNotImplemented = showNotImplemented;
        window.handleApplyForJob = handleApplyForJob;
        window.handleQuitJob = handleQuitJob;
        window.handleJobApplication = handleJobApplication;
        window.handleFireUser = handleFireUser;
        window.renderInfractionModal = renderInfractionModal;
        window.submitInfraction = submitInfraction;
        window.showUserInfractions = showUserInfractions;
        window.switchJobTab = switchJobTab;
        
    </script>
</body>
</html>
