<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collezione Puntine e Gestione Carte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 900px; 
        }
        .header {
            color: #4f46e5;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s;
            display: block;
            width: 100%;
            text-align: center;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #4f46e5;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-admin {
            background-color: #fef3c7;
            color: #d97706;
        }
        .badge-user {
            background-color: #e0f2f1;
            color: #0d9488;
        }
        .badge-banker {
            background-color: #d1e5fa;
            color: #0d6d94;
        }
        .badge-capo {
            background-color: #ffe4e6;
            color: #ef4444;
        }
        .badge-pending {
            background-color: #fee2e2;
            color: #ef4444;
        }
        .badge-confirmed {
            background-color: #d1fae5;
            color: #059669;
        }
        /* Stile specifico per il calendario */
        .calendar-box {
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            background-color: white;
        }
        /* Stile specifico per card di credito */
        .credit-card {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .card-number {
            font-family: monospace;
            font-size: 1.5rem;
            letter-spacing: 3px;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            display: block;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        /* Stile specifico per i prodotti */
        .product-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        @media (min-width: 640px) {
            body {
                align-items: center;
            }
        }
    </style>
</head>
<body>

    <div id="app-container" class="card">
        <h1 class="text-3xl header">Collezione Puntine</h1>
        <div id="loader" class="text-center text-gray-500 py-8">Connessione a Firebase...</div>
        <div id="content" class="hidden"></div>
    </div>

    <script>
        // NON MODIFICARE QUESTA VARIABILE
        const __app_id = 'thumbtack-collector-v1'; 
        
        // CONFIGURAZIONE REALE DEL PROGETTO 'puntine-collector'
        const firebaseConfig = {
            apiKey: "AIzaSyA6DwPiwQoRCxEC-lmlYJrchpLqzBEYB5w",
            authDomain: "puntine-collector.firebaseapp.com",
            projectId: "puntine-collector",
            storageBucket: "puntine-collector.firebasestorage.app",
            messagingSenderId: "709491476433",
            appId: "1:709491476433:web:cfcfc6d94bc2a5ef41c2f0"
        };
        
        // Stato globale per il calendario e le carte
        window.currentCalendarDate = new Date(); 
        window.calendarEvents = [];
        window.fakeCreditCards = []; 
        window.products = []; // Nuovo stato globale per i prodotti
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, orderBy, limit, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        setLogLevel('Debug'); // Mostra i log di Firestore nella console per il debug
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const config = firebaseConfig; 

        // --- GLOBAL STATE & FIREBASE SETUP ---
        const app = initializeApp(config);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentUserId = null;
        let currentUserData = null;
        let isAdmin = false;
        let isBanker = false; // Nuovo stato per il ruolo Banker
        let isMobiliHead = false; // Nuovo stato per il Capo Azienda Mobili Puntina

        // Credenziali hardcoded per il primo login Admin
        const ADMIN_USERNAME = "florianopu19";
        const ADMIN_PASSWORD = "1e2r3t";

        const RANKS = [
            'Non classificato',
            'Socio anziano',
            'Vice presidente',
            'Presidente'
            // NOTA: il grado Mobili Puntina non è un "rank" di puntine ma un "job/role"
        ];

        // --- HELPER FUNCTIONS ---

        const getRequestsCollection = () => collection(db, `artifacts/${appId}/public/data/thumbtack_requests`);
        const getAdminUsersCollection = () => collection(db, `artifacts/${appId}/public/data/all_users_view`); 
        const getEventsCollection = () => collection(db, `artifacts/${appId}/public/data/calendar_events`); 
        const getCardsCollection = () => collection(db, `artifacts/${appId}/public/data/fake_credit_cards`);
        // NUOVA COLLEZIONE PER I PRODOTTI (MERCATO "epunt")
        const getProductsCollection = () => collection(db, `artifacts/${appId}/public/data/products`);


        const showView = (html) => {
            document.getElementById('content').innerHTML = html;
        };
        
        const showLoader = (show) => {
            document.getElementById('loader').classList.toggle('hidden', !show);
            document.getElementById('content').classList.toggle('hidden', show);
        };

        // Formattazione per la valuta
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        };

        // Simple modal implementation (to replace alert/confirm)
        const showMessageBox = (title, message, type = 'info', confirmCallback = null) => {
            let color = 'bg-blue-500';
            if (type === 'success') color = 'bg-green-500';
            if (type === 'error') color = 'bg-red-500';
            if (type === 'alert') color = 'bg-yellow-500';

            const container = document.getElementById('app-container');
            const existingModal = document.getElementById('custom-modal');
            if (existingModal) existingModal.remove();

            const isConfirmation = confirmCallback !== null;
            const modalHTML = `
                <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="card max-w-sm">
                        <div class="flex items-center pb-3 border-b border-gray-200">
                            <div class="h-2 w-2 ${color} rounded-full mr-3"></div>
                            <h3 class="text-lg font-bold text-gray-900">${title}</h3>
                        </div>
                        <p class="py-4 text-gray-700">${message}</p>
                        <div class="flex justify-end space-x-3">
                            ${isConfirmation ? 
                                `<button id="modal-cancel" class="btn-secondary px-4 py-2">Annulla</button>
                                <button id="modal-confirm" class="${color.replace('bg-', 'bg-')} text-white px-4 py-2 rounded-lg font-semibold">Conferma</button>`
                                : 
                                `<button id="modal-ok" class="btn-primary px-4 py-2">OK</button>`
                            }
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('afterend', modalHTML);

            const modal = document.getElementById('custom-modal');
            
            const close = () => modal.remove();

            if (isConfirmation) {
                document.getElementById('modal-cancel').onclick = close;
                document.getElementById('modal-confirm').onclick = () => {
                    confirmCallback();
                    close();
                };
            } else {
                document.getElementById('modal-ok').onclick = close;
            }
        };


        // --- AUTHENTICATION & INITIAL SETUP ---

        const initializeAuth = async () => {
            showLoader(true);
            try {
                // Tentativo di autenticazione anonima
                await signInAnonymously(auth); 
            } catch (error) {
                console.error("Errore nell'autenticazione iniziale:", error);
                showMessageBox("Errore Critico", "Impossibile connettersi ai servizi di autenticazione Firebase. Controlla la tua configurazione.", "error");
            }
        };

        const handleSignIn = async (username, password, email = '') => { 
            showLoader(true); 

            if (!username || !password) {
                showMessageBox("Attenzione", "Inserisci username e password.", "alert");
                showLoader(false);
                return;
            }
            
            const userRef = doc(getAdminUsersCollection(), username);
            
            try {
                const userSnap = await getDoc(userRef);

                let userData;
                
                if (userSnap.exists()) {
                    // 1. Login
                    userData = userSnap.data();

                    if (userData.password !== password) {
                        showMessageBox("Errore di accesso", "Password errata per l'utente " + username + ".", "error");
                        showLoader(false);
                        return;
                    }

                    if (userData.authUid !== currentUserId) {
                        await updateDoc(userRef, { authUid: currentUserId });
                    }

                } else {
                    // 2. Registration
                    const isNewAdmin = (username === ADMIN_USERNAME && password === ADMIN_PASSWORD);
                    const initialRank = isNewAdmin ? 'Presidente' : 'Non classificato';
                    const initialRole = isNewAdmin ? 'admin' : 'user';

                    if (isNewAdmin) {
                        showMessageBox("Accesso Admin", `Benvenuto Admin ${username}! Sei loggato come ${initialRank}.`, "success");
                    } else {
                        showMessageBox("Registrazione Riuscita", `Benvenuto ${username}! Sei stato registrato con il grado ${initialRank}.`, "success");
                    }

                    userData = {
                        username: username,
                        password: password, 
                        email: email, 
                        authUid: currentUserId,
                        role: initialRole,
                        rank: initialRank,
                        isBanker: false, // Nuovo campo Banker
                        isMobiliHead: false, // Nuovo campo Capo Azienda
                        totalThumbtacks: 0,
                        lastUpdate: new Date().toISOString()
                    };

                    await setDoc(userRef, userData);
                }

                // --- GESTIONE FLUSSO DOPO LOGIN/REGISTRAZIONE ---
                currentUserData = userData;
                isAdmin = currentUserData.role === 'admin';
                isBanker = !!currentUserData.isBanker;
                isMobiliHead = !!currentUserData.isMobiliHead;
                
                if (isAdmin && currentUserData.password === ADMIN_PASSWORD) {
                    renderAdminPasswordChangePrompt();
                    showLoader(false);
                    return; 
                }

                startListeningForData();

                if (isAdmin) {
                    renderAdminDashboard();
                } else if (isMobiliHead) { // NUOVO: Priorità al Capo Azienda
                    renderMobiliPuntinaHeadDashboard();
                } else {
                    renderUserDashboard();
                }

            } catch (error) {
                console.error("Errore durante il login/registrazione:", error);
                showMessageBox("Errore di Sistema", "Si è verificato un errore durante l'accesso. Controlla la console.", "error");
            }
            showLoader(false);
        };

        const handleLogout = async () => {
            try {
                // Ricarica la pagina per resettare lo stato di autenticazione anonimo
                location.reload(); 
            } catch (error) {
                console.error("Logout failed:", error);
            }
        };

        // --- UI MANAGEMENT ---
        const renderWelcomeScreen = () => {
            const html = `
                <p class="text-gray-600 text-center mb-6">Benvenuto nel sistema di collezione di puntine!</p>
                <div id="auth-view">
                    <div id="login-form">
                        <input type="text" id="username" placeholder="Username" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
                        <input type="email" id="email" placeholder="Email (solo per la registrazione, facoltativa)" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
                        <input type="password" id="password" placeholder="Password" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
                        <button onclick="window.handleLoginClick()" class="btn-primary mb-3">Accedi / Registrati</button>
                        <p class="text-sm text-gray-500 text-center mt-4">
                            Il tuo ID di sessione (per debug): <code class="text-xs break-words">${currentUserId || 'N/D'}</code>
                        </p>
                    </div>
                </div>
            `;
            showView(html);
        };

        const handleLoginClick = () => {
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            handleSignIn(username, password, email);
        };

        const renderAdminPasswordChangePrompt = () => {
            const html = `
                <div class="bg-yellow-100 p-4 rounded-lg mb-6 border border-yellow-300">
                    <h2 class="text-xl font-bold text-yellow-800 mb-2">⚠ SICUREZZA CRITICA ⚠</h2>
                    <p class="text-yellow-700 mb-4">
                        Stai utilizzando la password Admin predefinita. Per motivi di sicurezza, devi cambiarla per accedere alla Dashboard.
                    </p>
                    <input type="password" id="new_password" placeholder="Nuova Password (min 6 caratteri)" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" />
                    <input type="password" id="confirm_password" placeholder="Conferma Nuova Password" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" />
                    <button onclick="window.handleAdminPasswordChange()" class="btn-primary bg-red-600 hover:bg-red-700">Cambia Password Admin</button>
                </div>
            `;
            showView(html);
        };

        const handleAdminPasswordChange = async () => {
            const newPassword = document.getElementById('new_password').value.trim();
            const confirmPassword = document.getElementById('confirm_password').value.trim();
            const adminUsername = currentUserData.username;

            if (newPassword.length < 6) {
                showMessageBox("Attenzione", "La nuova password deve contenere almeno 6 caratteri.", "alert");
                return;
            }
            if (newPassword !== confirmPassword) {
                showMessageBox("Attenzione", "Le password non corrispondono.", "alert");
                return;
            }
            if (newPassword === ADMIN_PASSWORD) {
                showMessageBox("Attenzione", "La nuova password non può essere uguale a quella predefinita.", "alert");
                return;
            }

            showLoader(true);
            try {
                const userRef = doc(getAdminUsersCollection(), adminUsername);
                await updateDoc(userRef, {
                    password: newPassword,
                    lastUpdate: new Date().toISOString()
                });

                currentUserData.password = newPassword; 

                showMessageBox("Successo", "Password Admin aggiornata con successo! Accesso alla Dashboard.", "success", () => {
                    startListeningForData();
                    renderAdminDashboard();
                });

            } catch (error) {
                console.error("Errore nel cambio password Admin:", error);
                showMessageBox("Errore di Sistema", "Impossibile aggiornare la password. Controlla la console.", "error");
            }
            showLoader(false);
        };


        // --- USER DASHBOARD ---

        const renderUserDashboard = () => {
            const thumbtackRequests = window.thumbtackRequests || [];
            const userCards = window.fakeCreditCards || []; // Le carte dell'utente

            // Filtra le richieste dell'utente corrente (basandosi sull'UID)
            const userRequests = thumbtackRequests.filter(r => r.authUid === currentUserId);
            const userPendingRequests = userRequests.filter(r => r.status === 'Pending');
            const userHistoryRequests = userRequests.filter(r => r.status !== 'Pending');

            let pendingRequestsHTML = '';
            if (userPendingRequests.length > 0) {
                pendingRequestsHTML = `
                    <h3 class="text-lg font-semibold mt-6 mb-3 text-red-600">Richieste in Sospeso</h3>
                    <div class="border rounded-lg overflow-hidden">
                    ${userPendingRequests.map(req => `
                        <div class="list-item bg-red-50/50">
                            <span>${req.quantity} puntine (${new Date(req.timestamp).toLocaleDateString()})</span>
                            <span class="badge badge-pending">In attesa</span>
                        </div>
                    `).join('')}
                    </div>
                `;
            }

            let cardListHTML = '';
            if (userCards.length > 0) {
                cardListHTML = userCards.map(card => `
                    <div class="credit-card mb-4">
                        <p class="text-sm font-light">Carta Finta Registrata</p>
                        <span class="card-number">${card.id.replace(/(\d{4})/g, '$1 ').trim()}</span>
                        <div class="flex justify-between items-center text-xl font-bold">
                            <p>Saldo Attuale:</p>
                            <p class="text-green-300">${formatCurrency(card.balance)}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                 cardListHTML = `<p class="text-center text-gray-500 py-4">Nessuna carta registrata. Registrane una qui sotto!</p>`;
            }
            
            // RUOLI AGGIUNTIVI VISIBILI ALL'UTENTE
            const userRolesBadges = [];
            if (isMobiliHead) userRolesBadges.push('<span class="badge badge-capo ml-2">CAPO AZIENDA MOBILI</span>');
            if (isBanker) userRolesBadges.push('<span class="badge badge-banker ml-2">BANCARIO</span>');


            const html = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">${currentUserData.username} ${userRolesBadges.join('')}</h2>
                    <button onclick="window.handleLogout()" class="text-sm text-red-500 hover:text-red-700">Logout</button>
                </div>

                <div class="bg-indigo-50 p-4 rounded-lg mb-6 shadow-inner">
                    <p class="text-indigo-700 text-sm">Il tuo Grado: <span class="font-bold">${currentUserData.rank}</span></p>
                    <p class="text-indigo-700 text-sm mt-1">Puntine Totali: <span class="font-bold text-xl">${currentUserData.totalThumbtacks}</span></p>
                    ${currentUserData.email ? `<p class="text-indigo-700 text-xs mt-1">Email: ${currentUserData.email}</p>` : ''}
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <button onclick="window.renderMarketplaceView()" class="btn-primary bg-red-500 hover:bg-red-600">
                        Vai su epunt (Marketplace)
                    </button>
                    <button onclick="window.renderCalendarView()" class="btn-primary">Visualizza Calendario Eventi</button>
                </div>
                
                
                <h3 class="text-xl font-bold text-gray-700 mb-3 mt-6 border-b pb-2">Gestione Carte di Credito Finte</h3>
                <div id="card-list" class="mb-6">
                    ${cardListHTML}
                </div>
                
                <div class="p-4 border border-gray-200 rounded-lg mb-8">
                    <h4 class="text-lg font-semibold mb-3 text-gray-700">Registra Nuova Carta (12 Cifre)</h4>
                    <input type="text" id="card_number_input" placeholder="XXXX XXXX XXXX" maxlength="12" pattern="[0-9]{12}" 
                        oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 12);" 
                        class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-center text-lg font-mono" />
                    <button onclick="window.registerNewCard()" class="btn-primary">Registra Carta</button>
                </div>
                <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">Invia Richiesta Puntine</h3>
                <div class="p-4 border border-gray-200 rounded-lg">
                    <label for="thumbtack_count" class="block text-sm font-medium text-gray-700 mb-2">Quante puntine hai collezionato?</label>
                    <input type="number" id="thumbtack_count" min="1" value="1" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
                    <button onclick="window.submitThumbtackRequest()" class="btn-primary">Invia per Approvazione</button>
                </div>
                
                ${pendingRequestsHTML}
                
                ${userHistoryRequests.length > 0 ? `
                    <h3 class="text-lg font-semibold mt-6 mb-3 text-gray-700">Storico Richieste Recenti</h3>
                    <div class="border rounded-lg overflow-hidden">
                    ${userHistoryRequests.map((req, index) => {
                        const isConfirmed = req.status === 'Confirmed';
                        const badgeClass = isConfirmed ? 'badge-confirmed' : 'badge-pending';
                        const badgeText = isConfirmed ? 'Accettata' : 'Rifiutata';
                        const bgColor = isConfirmed ? 'bg-green-50/50' : 'bg-red-50/50';

                        return `
                            <div class="list-item ${bgColor}">
                                <span>${req.quantity} puntine (${new Date(req.timestamp).toLocaleDateString()})</span>
                                <span class="badge ${badgeClass}">${badgeText}</span>
                            </div>
                        `;
                    }).join('')}
                    </div>
                ` : ''}
            `;
            showView(html);
        };
        
        // --- ADMIN DASHBOARD ---

        const renderAdminDashboard = () => {
            const allUsers = window.allUsers || [];
            const thumbtackRequests = (window.thumbtackRequests || []).filter(r => r.status === 'Pending');
            const allCards = window.fakeCreditCards || [];

             const usersHtml = allUsers.map((user, index) => {
                const currentRankIndex = RANKS.indexOf(user.rank);
                const nextRankIndex = currentRankIndex < RANKS.length - 1 ? currentRankIndex + 1 : currentRankIndex;
                const nextRankName = RANKS[nextRankIndex];
                
                const badges = [];
                if (user.username === ADMIN_USERNAME) badges.push('<span class="badge badge-admin ml-2">ADMIN</span>');
                if (user.isMobiliHead) badges.push('<span class="badge badge-capo ml-2">CAPO AZIENDA</span>');
                if (user.isBanker) badges.push('<span class="badge badge-banker ml-2">BANCARIO</span>');

                return `
                    <div class="list-item ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} flex-wrap sm:flex-nowrap">
                        <div class="flex-1 min-w-0 mr-4 py-1">
                            <p class="font-semibold text-gray-900">${user.username} ${badges.join('')}</p>
                            <p class="text-sm text-gray-500">Puntine: ${user.totalThumbtacks} - Grado: ${user.rank}</p>
                        </div>
                        
                        <div class="flex items-center space-x-2 flex-wrap justify-end py-1">
                        ${user.username !== ADMIN_USERNAME ? `
                            <button onclick="window.handleRankChange('${user.username}', 'Promote')" 
                                    class="text-xs font-semibold py-1 px-3 rounded-full text-white transition-opacity ${RANKS.indexOf(user.rank) < RANKS.length - 1 ? 'bg-indigo-500 hover:bg-indigo-600' : 'bg-green-500 opacity-70 cursor-default'}" 
                                    ${currentRankIndex === RANKS.length - 1 ? 'disabled' : ''}>
                                ${currentRankIndex < RANKS.length - 1 ? `Promuovi a ${nextRankName}` : 'Grado Massimo'}
                            </button>
                            
                            <button onclick="window.handleJobAssignment('${user.username}', 'isMobiliHead', ${!user.isMobiliHead})" 
                                    class="text-xs font-semibold py-1 px-3 rounded-full text-white transition-colors ${user.isMobiliHead ? 'bg-red-500 hover:bg-red-600' : 'bg-pink-500 hover:bg-pink-600'}">
                                ${user.isMobiliHead ? 'Revoca Capo Az.' : 'Nomina Capo Az.'}
                            </button>
                            
                            <button onclick="window.handleJobAssignment('${user.username}', 'isBanker', ${!user.isBanker})" 
                                    class="text-xs font-semibold py-1 px-3 rounded-full text-white transition-colors ${user.isBanker ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'}">
                                ${user.isBanker ? 'Revoca Banker' : 'Nomina Banker'}
                            </button>
                            
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            const requestsHtml = thumbtackRequests.length > 0 ? thumbtackRequests.map((req, index) => `
                <div class="list-item ${index % 2 === 0 ? 'bg-red-50' : 'bg-white'}">
                    <div class="flex-1 min-w-0 mr-4">
                        <p class="font-semibold text-gray-900">${req.username} richiede ${req.quantity} puntine.</p>
                        <p class="text-xs text-gray-500">${new Date(req.timestamp).toLocaleString()}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.handleRequestAction('${req.id}', 'Accept', ${req.quantity}, '${req.authUid}', '${req.username}')" 
                                class="bg-green-500 hover:bg-green-600 text-white text-xs font-semibold py-1 px-3 rounded-lg">Accetta</button>
                        <button onclick="window.handleRequestAction('${req.id}', 'Reject', ${req.quantity}, '${req.authUid}', '${req.username}')" 
                                class="bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-1 px-3 rounded-lg">Rifiuta</button>
                    </div>
                </div>
            `).join('') : '<p class="text-center text-gray-500 py-4">Nessuna richiesta di puntine in sospeso.</p>';
            
            // HTML per la lista di TUTTE le Carte
            const adminCardsHtml = allCards.length > 0 ? allCards.map((card, index) => `
                <div class="list-item ${index % 2 === 0 ? 'bg-indigo-50' : 'bg-white'} flex-wrap sm:flex-nowrap">
                    <div class="flex-1 min-w-0 mr-4 p-1">
                        <p class="font-bold text-gray-900 text-lg font-mono">${card.id.replace(/(\d{4})/g, '$1 ').trim()}</p>
                        <p class="text-sm text-gray-500">Proprietario: <span class="font-semibold">${card.ownerUsername}</span></p>
                    </div>
                    <div class="min-w-0 mr-4 p-1">
                        <p class="text-lg font-bold text-indigo-600 whitespace-nowrap">Saldo: ${formatCurrency(card.balance)}</p>
                    </div>
                    <div class="flex space-x-2 mt-2 sm:mt-0">
                        <button onclick="window.renderBalanceModal('${card.id}', ${card.balance}, '${card.ownerUsername}')" 
                                class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-semibold py-1 px-3 rounded-lg min-w-[100px]">Modifica</button>
                        <button onclick="window.handleAdminCardAction('${card.id}', 'delete')" 
                                class="bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-1 px-3 rounded-lg min-w-[80px]">Rimuovi</button>
                    </div>
                </div>
            `).join('') : '<p class="text-center text-gray-500 py-4">Nessuna carta finta registrata nel sistema.</p>';


            const html = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Dashboard Admin</h2>
                    <div class="flex space-x-3">
                         <button onclick="window.renderMarketplaceView()" class="text-sm font-semibold text-red-500 hover:text-red-700">epunt</button>
                        <button onclick="window.renderCalendarView()" class="text-sm font-semibold text-indigo-500 hover:text-indigo-700">Calendario</button>
                        <button onclick="window.handleLogout()" class="text-sm text-red-500 hover:text-red-700">Logout</button>
                    </div>
                </div>

                <div class="bg-red-100 p-4 rounded-lg mb-6">
                    <h3 class="text-xl font-bold text-red-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        Richieste Puntine Pendenti
                        ${thumbtackRequests.length > 0 ? `<span class="badge badge-pending ml-3">${thumbtackRequests.length}</span>` : ''}
                    </h3>
                </div>
                
                <div class="border rounded-lg overflow-hidden mb-8">
                    ${requestsHtml}
                </div>
                
                <h3 class="text-xl font-bold text-indigo-700 mb-3 border-b pb-2">Gestione Carte di Credito Finte (Globale)</h3>
                <div class="border rounded-lg overflow-hidden mb-8">
                    ${adminCardsHtml}
                </div>
                
                <h3 class="text-xl font-bold text-gray-700 mb-3">Gestione Utenti (Grado e Ruoli)</h3>
                <div class="border rounded-lg overflow-hidden">
                    ${usersHtml}
                </div>
            `;
            showView(html);
        };
        
        // --- DASHBOARD CAPO AZIENDA MOBILI PUNTINA ---
        
        const renderMobiliPuntinaHeadDashboard = () => {
            const products = window.products || [];
            
            const productListHtml = products.length > 0 ? products.map((product, index) => `
                <div class="list-item ${index % 2 === 0 ? 'bg-pink-50' : 'bg-white'} flex-wrap sm:flex-nowrap">
                    <div class="flex-1 min-w-0 mr-4 py-1">
                        <p class="font-bold text-gray-900 text-lg">${product.name}</p>
                        <p class="text-sm text-gray-500">${product.description}</p>
                    </div>
                    <div class="min-w-0 mr-4 py-1">
                        <p class="text-lg font-bold text-red-600 whitespace-nowrap">Prezzo: ${formatCurrency(product.price)}</p>
                    </div>
                    <div class="flex space-x-2 mt-2 sm:mt-0">
                        <button onclick="window.renderProductModal('${product.id}', '${product.name}', '${product.description}', ${product.price})" 
                                class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-semibold py-1 px-3 rounded-lg min-w-[80px]">Modifica</button>
                        <button onclick="window.deleteProduct('${product.id}', '${product.name}')" 
                                class="bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-1 px-3 rounded-lg min-w-[80px]">Rimuovi</button>
                    </div>
                </div>
            `).join('') : '<p class="text-center text-gray-500 py-4">Nessun mobile in vendita al momento. Aggiungine uno!</p>';


            const html = `
                <div class="flex justify-between items-center mb-6 border-b pb-3 border-red-300">
                    <h2 class="text-2xl font-bold text-red-800">Dashboard Capo Azienda Mobili Puntina</h2>
                    <div class="flex space-x-3">
                        <button onclick="window.renderMarketplaceView()" class="text-sm font-semibold text-red-500 hover:text-red-700">epunt Pubblico</button>
                        <button onclick="window.handleLogout()" class="text-sm text-red-500 hover:text-red-700">Logout</button>
                    </div>
                </div>
                
                <div class="bg-pink-100 p-4 rounded-lg mb-6 shadow-inner">
                    <p class="text-pink-700 font-bold">Benvenuto, ${currentUserData.username}! Qui gestisci i mobili in vendita su epunt.</p>
                </div>

                <div class="mb-8">
                    <button onclick="window.renderProductModal()" class="btn-primary bg-pink-600 hover:bg-pink-700 flex items-center justify-center w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Aggiungi Nuovo Mobile
                    </button>
                </div>
                
                <h3 class="text-xl font-bold text-gray-700 mb-3 border-b pb-2">Catalogo Mobili in Vendita</h3>
                <div class="border rounded-lg overflow-hidden">
                    ${productListHtml}
                </div>
                
                <div class="mt-6">
                    <button onclick="window.handleBackToDashboard()" class="text-sm text-gray-500 hover:text-gray-700">Torna alla Dashboard Utente</button>
                </div>
            `;
            showView(html);
        }
        
        // --- MARKETPLACE "epunt" VIEW ---
        
        const renderMarketplaceView = () => {
             const products = window.products || [];
             
             const isHead = isMobiliHead;
             
             const productCardsHtml = products.length > 0 ? products.map(product => `
                <div class="product-card">
                    <h4 class="text-xl font-bold text-gray-900 mb-2">${product.name}</h4>
                    <p class="text-sm text-gray-600 mb-3">${product.description || 'Nessuna descrizione.'}</p>
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-2xl font-bold text-red-600">${formatCurrency(product.price)}</p>
                        <p class="text-xs text-gray-500">Venditore: ${product.sellerUsername}</p>
                    </div>
                    <button onclick="window.handleProductPurchase('${product.id}', '${product.name}')" 
                            class="btn-primary bg-green-500 hover:bg-green-600 py-2 px-4 w-full text-sm">
                        Acquista Ora
                    </button>
                </div>
             `).join('') : '<p class="text-center text-gray-500 py-8">Nessun prodotto (mobile) in vendita su epunt al momento.</p>';


             const html = `
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-red-600">epunt: Marketplace Mobili</h2>
                    <button onclick="window.handleBackToDashboard()" class="text-sm text-indigo-500 hover:text-indigo-700">
                        Torna alla Dashboard
                    </button>
                </div>
                
                ${isHead ? 
                    `<div class="mb-6 p-4 bg-pink-50 border border-pink-300 rounded-lg">
                        <p class="text-pink-700 font-semibold text-center">Sei il Capo Azienda Mobili! <a href="#" onclick="window.renderMobiliPuntinaHeadDashboard()" class="text-pink-800 underline">Gestisci i prodotti qui.</a></p>
                    </div>` : ''}

                <p class="text-gray-600 mb-6">Visualizza i prodotti in vendita. Dopo l'acquisto, il prodotto ti sarà consegnato a scuola.</p>
                
                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${productCardsHtml}
                </div>
             `;
             showView(html);
        }


        // --- CARD MANAGEMENT LOGIC ---

        const isValidCardNumber = (cardNumber) => {
            const cleaned = cardNumber.replace(/\s/g, '');
            return /^\d{12}$/.test(cleaned);
        };

        const registerNewCard = async () => {
            const input = document.getElementById('card_number_input');
            const cardNumber = input.value.trim();

            if (!isValidCardNumber(cardNumber)) {
                showMessageBox("Errore", "Il numero di carta deve essere esattamente di 12 cifre numeriche.", "error");
                return;
            }
            
            // Verifica se la carta esiste già
            const cardRef = doc(getCardsCollection(), cardNumber);
            const cardSnap = await getDoc(cardRef);

            if (cardSnap.exists()) {
                showMessageBox("Errore", "Questa carta è già stata registrata nel sistema.", "error");
                return;
            }
            
            showLoader(true);
            try {
                const newCardData = {
                    ownerUid: currentUserId,
                    ownerUsername: currentUserData.username,
                    balance: 0.00, // Inizia con saldo zero
                    createdAt: new Date().toISOString()
                };

                // Uso il numero di carta come ID del documento
                await setDoc(cardRef, newCardData);
                input.value = '';
                showMessageBox("Successo", `Carta ${cardNumber} registrata con successo! Saldo iniziale: ${formatCurrency(0)}.`, "success");
            } catch (error) {
                console.error("Errore nella registrazione della carta:", error);
                showMessageBox("Errore", "Impossibile registrare la carta.", "error");
            }
            showLoader(false);
        };

        // Admin function: modal for balance modification
        const renderBalanceModal = (cardId, currentBalance, ownerUsername) => {
            if (!isAdmin && !isBanker) return;
            const container = document.getElementById('app-container');
            const existingModal = document.getElementById('balance-modal');
            if (existingModal) existingModal.remove();

            const modalHTML = `
                <div id="balance-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="card max-w-md">
                        <h3 class="text-lg font-bold text-gray-900 border-b pb-3 mb-4">Modifica Saldo Carta</h3>
                        <p class="text-sm text-gray-600 mb-2">Carta: <span class="font-mono font-bold text-indigo-700">${cardId.replace(/(\d{4})/g, '$1 ').trim()}</span></p>
                        <p class="text-sm text-gray-600 mb-4">Proprietario: ${ownerUsername} | Saldo Attuale: <span class="font-bold">${formatCurrency(currentBalance)}</span></p>
                        
                        <label class="block text-sm font-medium text-gray-700 mb-1">Importo da Aggiungere/Sottrarre</label>
                        <input type="number" id="balance_amount" step="0.01" value="0.00" class="w-full p-3 mb-4 border border-gray-300 rounded-lg" required />
                        
                        <div class="flex justify-end space-x-3">
                            <button onclick="document.getElementById('balance-modal').remove()" class="btn-secondary w-auto px-4 py-2">Annulla</button>
                            <button onclick="window.handleAdminCardAction('${cardId}', 'subtract')" class="bg-red-500 hover:bg-red-600 text-white w-auto px-4 py-2 rounded-lg font-semibold">Sottrai</button>
                            <button onclick="window.handleAdminCardAction('${cardId}', 'add')" class="bg-green-500 hover:bg-green-600 text-white w-auto px-4 py-2 rounded-lg font-semibold">Aggiungi</button>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('afterend', modalHTML);
        };
        
        // Admin function: process card actions (add/subtract/delete)
        const handleAdminCardAction = (cardId, action) => {
            if (!isAdmin && !isBanker) return;
            
            if (action === 'delete') {
                showMessageBox("Conferma Eliminazione", `Sei sicuro di voler RIMUOVERE definitivamente la carta ${cardId}?`, 'error', async () => {
                    showLoader(true);
                    try {
                        await deleteDoc(doc(getCardsCollection(), cardId));
                        showMessageBox("Successo", `Carta ${cardId} rimossa con successo.`, "success");
                    } catch (error) {
                        console.error("Errore nell'eliminazione della carta:", error);
                        showMessageBox("Errore", "Impossibile rimuovere la carta.", "error");
                    }
                    showLoader(false);
                });
                document.getElementById('balance-modal')?.remove();
                return;
            }
            
            // Se l'azione è 'add' o 'subtract', prendi l'importo dal modale
            const amountInput = document.getElementById('balance_amount');
            const amount = parseFloat(amountInput.value);
            
            if (isNaN(amount) || amount <= 0) {
                 showMessageBox("Attenzione", "Inserisci un importo valido e positivo per la transazione.", "alert");
                 return;
            }
            
            const card = window.fakeCreditCards.find(c => c.id === cardId);
            if (!card) {
                showMessageBox("Errore", "Carta non trovata.", "error");
                document.getElementById('balance-modal')?.remove();
                return;
            }
            
            let newBalance = card.balance;
            let transactionType;

            if (action === 'add') {
                newBalance += amount;
                transactionType = 'Aggiunta';
            } else if (action === 'subtract') {
                newBalance -= amount;
                transactionType = 'Sottrazione';
                if (newBalance < 0) {
                    showMessageBox("Attenzione", `L'operazione renderebbe il saldo negativo (${formatCurrency(newBalance)}). Procedi?`, 'alert', () => {
                        updateCardBalance(cardId, newBalance, transactionType, amount);
                    });
                    return;
                }
            }
            
            updateCardBalance(cardId, newBalance, transactionType, amount);
        };
        
        const updateCardBalance = async (cardId, newBalance, transactionType, amount) => {
            document.getElementById('balance-modal')?.remove(); // Chiude il modale
            showLoader(true);
            
            try {
                await updateDoc(doc(getCardsCollection(), cardId), {
                    balance: newBalance,
                    lastUpdate: new Date().toISOString()
                });
                showMessageBox("Successo", `${transactionType} di ${formatCurrency(amount)} eseguita. Nuovo saldo: ${formatCurrency(newBalance)}.`, "success");
            } catch (error) {
                console.error("Errore nell'aggiornamento del saldo:", error);
                showMessageBox("Errore", "Impossibile aggiornare il saldo della carta.", "error");
            }
            showLoader(false);
        }

        // --- REAL-TIME DATA LISTENERS ---

        const startListeningForData = () => {
            // 1. All Users (Used by Admin and for User Profile updates)
            const qUsers = getAdminUsersCollection();
            onSnapshot(qUsers, (snapshot) => {
                let users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                users.sort((a, b) => b.totalThumbtacks - a.totalThumbtacks); 
                window.allUsers = users;
                
                if (!isAdmin && currentUserData) {
                    // Update current user data if logged in as non-admin
                    const updatedUser = users.find(u => u.username === currentUserData.username);
                    if (updatedUser) {
                        currentUserData = updatedUser;
                        isBanker = !!currentUserData.isBanker;
                        isMobiliHead = !!currentUserData.isMobiliHead;
                    }
                }
                
                if (document.getElementById('content').innerHTML.includes('Dashboard Admin')) {
                     renderAdminDashboard();
                } else if (isMobiliHead && document.getElementById('content').innerHTML.includes('Capo Azienda Mobili Puntina')) {
                     renderMobiliPuntinaHeadDashboard();
                } else if (document.getElementById('content').innerHTML.includes('Puntine Totali')) {
                    renderUserDashboard();
                }

            }, (error) => console.error("Errore nel listener Utenti:", error));

            // 2. All Requests (Admin/User specific)
            if (isAdmin) {
                const qRequests = query(getRequestsCollection(), orderBy("timestamp", "desc"));
                onSnapshot(qRequests, (snapshot) => {
                    window.thumbtackRequests = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    if (document.getElementById('content').innerHTML.includes('Dashboard Admin')) {
                        renderAdminDashboard();
                    }
                }, (error) => console.error("Errore nel listener Richieste:", error));
            } else {
                // User Requests (Recenti)
                const qUserRequests = query(
                    getRequestsCollection(),
                    where("authUid", "==", currentUserId),
                    orderBy("timestamp", "desc"),
                    limit(10)
                ); 

                onSnapshot(qUserRequests, (snapshot) => {
                    window.thumbtackRequests = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    if (document.getElementById('content').innerHTML.includes('Puntine Totali')) {
                        renderUserDashboard();
                    }
                }, (error) => console.error("Errore nel listener Richieste Utente:", error));
            }

            // 3. All Cards (Admin/User specific)
            const cardQuery = (isAdmin || isBanker) ? getCardsCollection() : query(getCardsCollection(), where("ownerUid", "==", currentUserId));
            onSnapshot(cardQuery, (snapshot) => {
                window.fakeCreditCards = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                 if (document.getElementById('content').innerHTML.includes('Puntine Totali') || document.getElementById('content').innerHTML.includes('Dashboard Admin')) {
                    if (isAdmin || isBanker) renderAdminDashboard();
                    else renderUserDashboard();
                }
            }, (error) => console.error("Errore nel listener Carte:", error));
            
            // 4. Calendar Events (Publicly viewable by all)
            const qEvents = query(getEventsCollection(), orderBy("date", "asc")); 
            onSnapshot(qEvents, (snapshot) => {
                window.calendarEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('calendar-container')) {
                    renderCalendarView(window.currentCalendarDate);
                }
            }, (error) => console.error("Errore nel listener Eventi Calendario:", error));
            
            // 5. Products (Publicly viewable by all)
            const qProducts = getProductsCollection();
            onSnapshot(qProducts, (snapshot) => {
                window.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 if (document.getElementById('product-list')) {
                    renderMarketplaceView();
                } else if (isMobiliHead && document.getElementById('content').innerHTML.includes('Dashboard Capo Azienda')) {
                    renderMobiliPuntinaHeadDashboard();
                }
            }, (error) => console.error("Errore nel listener Prodotti:", error));
        };
        
        // --- REQUESTS AND RANKS LOGIC ---
        
        // NUOVA FUNZIONE: Assegnazione Ruoli (Banker/Capo Azienda)
        const handleJobAssignment = (username, jobKey, assignment) => {
             if (!isAdmin) return;

             const jobName = jobKey === 'isBanker' ? 'Bancario' : 'Capo Azienda Mobili Puntina';
             const action = assignment ? 'Nominare' : 'Revocare';
             const message = `Sei sicuro di voler ${action} l'utente ${username} come ${jobName}?`;

             showMessageBox("Conferma Ruolo", message, 'alert', async () => {
                showLoader(true);
                try {
                    const userRef = doc(getAdminUsersCollection(), username);
                    await updateDoc(userRef, { [jobKey]: assignment });
                    showMessageBox("Successo", `${username} è stato ${assignment ? 'nominato' : 'revocato'} come ${jobName}.`, "success");
                } catch (error) {
                    console.error(`Errore nell'assegnazione del ruolo ${jobName}:`, error);
                    showMessageBox("Errore", "Impossibile aggiornare il ruolo.", "error");
                }
                showLoader(false);
             });
        }

        const submitThumbtackRequest = async () => {
            const countInput = document.getElementById('thumbtack_count');
            const quantity = parseInt(countInput.value, 10);

            if (isNaN(quantity) || quantity <= 0) {
                showMessageBox("Attenzione", "Inserisci una quantità di puntine valida (maggiore di zero).", "alert");
                return;
            }

            if (window.thumbtackRequests && window.thumbtackRequests.some(r => r.authUid === currentUserId && r.status === 'Pending')) {
                showMessageBox("Attenzione", "Hai già una richiesta in sospeso. Attendi l'approvazione dell'Admin.", "alert");
                return;
            }

            showLoader(true);
            try {
                await addDoc(getRequestsCollection(), {
                    username: currentUserData.username,
                    authUid: currentUserId,
                    quantity: quantity,
                    status: 'Pending',
                    timestamp: new Date().toISOString()
                });
                countInput.value = '1';
                showMessageBox("Richiesta Inviata", `Richiesta di ${quantity} puntine inviata con successo all'Admin!`, "success");
            } catch (error) {
                console.error("Errore nell'invio della richiesta:", error);
                showMessageBox("Errore", "Impossibile inviare la richiesta.", "error");
            }
            showLoader(false);
        };
        
        const processRequest = async (requestId, action, quantity, username) => {
            const requestRef = doc(getRequestsCollection(), requestId);

            await updateDoc(requestRef, { status: action === 'Accept' ? 'Confirmed' : 'Rejected' });

            if (action === 'Accept') {
                const userRef = doc(getAdminUsersCollection(), username);
                
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    const newTotal = userData.totalThumbtacks + quantity;
                    
                    await updateDoc(userRef, {
                        totalThumbtacks: newTotal
                    });
                }
            }
        };
        
        const handleRequestAction = (requestId, action, quantity, authUid, username) => {
            const message = action === 'Accept' 
                ? `Sei sicuro di voler ACCETTARE la richiesta di ${quantity} puntine per ${username}?`
                : `Sei sicuro di voler RIFIUTARE la richiesta di ${quantity} puntine per ${username}?`;

            showMessageBox(action === 'Accept' ? "Accetta Richiesta" : "Rifiuta Richiesta", message, 'alert', async () => {
                showLoader(true);
                try {
                    await processRequest(requestId, action, quantity, username);
                    showMessageBox("Successo", `Richiesta di ${username} ${action === 'Accept' ? 'accettata' : 'rifiutata'} con successo.`, "success");
                } catch (error) {
                    console.error(`Errore durante l'azione ${action}:`, error);
                    showMessageBox("Errore", "Impossibile processare la richiesta.", "error");
                }
                showLoader(false);
            });
        };
        
        const handleRankChange = (username) => {
            if (!isAdmin) return;
            const user = window.allUsers.find(u => u.username === username);
            if (!user) return;

            const currentRankIndex = RANKS.indexOf(user.rank);
            const nextRankIndex = currentRankIndex + 1;

            if (nextRankIndex >= RANKS.length) {
                showMessageBox("Attenzione", `${username} ha già il grado massimo: ${user.rank}.`, "alert");
                return;
            }

            const nextRankName = RANKS[nextRankIndex];

            showMessageBox("Conferma Promozione", `Promuovere ${username} al grado: ${nextRankName}?`, 'info', async () => {
                showLoader(true);
                try {
                    const userRef = doc(getAdminUsersCollection(), username);
                    await updateDoc(userRef, { rank: nextRankName });
                    showMessageBox("Successo", `${username} è stato promosso a ${nextRankName}!`, "success");
                } catch (error) {
                    console.error("Errore nella promozione:", error);
                    showMessageBox("Errore", "Impossibile aggiornare il grado.", "error");
                }
                showLoader(false);
            });
        };
        
        // --- PRODOTTI / MARKETPLACE LOGIC ---
        
        const renderProductModal = (id = null, name = '', description = '', price = 0) => {
            if (!isMobiliHead) return;
            const container = document.getElementById('app-container');
            const existingModal = document.getElementById('product-modal');
            if (existingModal) existingModal.remove();
            
            const isEdit = id !== null;

            const modalHTML = `
                <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="card max-w-md">
                        <h3 class="text-lg font-bold text-gray-900 border-b pb-3 mb-4">${isEdit ? 'Modifica Mobile' : 'Aggiungi Nuovo Mobile'}</h3>
                        
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome Mobile</label>
                        <input type="text" id="product_name" placeholder="Nome del prodotto" value="${name}" class="w-full p-3 mb-4 border border-gray-300 rounded-lg" required />
                        
                        <label class="block text-sm font-medium text-gray-700 mb-1">Prezzo (€)</label>
                        <input type="number" id="product_price" step="0.01" min="0.01" value="${price.toFixed(2)}" class="w-full p-3 mb-4 border border-gray-300 rounded-lg" required />

                        <label class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
                        <textarea id="product_description" placeholder="Dettagli del prodotto..." class="w-full p-3 mb-6 border border-gray-300 rounded-lg">${description}</textarea>
                        
                        <div class="flex justify-end space-x-3">
                            <button onclick="document.getElementById('product-modal').remove()" class="btn-secondary w-auto px-4 py-2">Annulla</button>
                            <button onclick="window.submitNewProduct('${id}')" class="btn-primary w-auto px-4 py-2">${isEdit ? 'Salva Modifiche' : 'Aggiungi Prodotto'}</button>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('afterend', modalHTML);
        }
        
        const submitNewProduct = async (id) => {
            if (!isMobiliHead) return;
            const name = document.getElementById('product_name').value.trim();
            const price = parseFloat(document.getElementById('product_price').value);
            const description = document.getElementById('product_description').value.trim();

            if (!name || isNaN(price) || price <= 0) {
                showMessageBox("Attenzione", "Inserisci un nome valido e un prezzo maggiore di zero.", "alert");
                return;
            }

            document.getElementById('product-modal').remove(); 
            showLoader(true);
            
            const productData = {
                name: name,
                price: price, 
                description: description,
                sellerUid: currentUserId,
                sellerUsername: currentUserData.username,
                lastUpdate: new Date().toISOString()
            };
            
            try {
                if (id) {
                    // Modifica
                    await updateDoc(doc(getProductsCollection(), id), productData);
                    showMessageBox("Successo", `Il mobile '${name}' è stato aggiornato.`, "success");
                } else {
                    // Aggiungi
                    await addDoc(getProductsCollection(), productData);
                    showMessageBox("Successo", `Il mobile '${name}' è stato messo in vendita su epunt!`, "success");
                }
            } catch (error) {
                console.error("Errore nell'operazione prodotto:", error);
                showMessageBox("Errore", "Impossibile salvare il mobile.", "error");
            }
            showLoader(false);
        }
        
        const deleteProduct = (id, name) => {
            if (!isMobiliHead) return;
            
            showMessageBox("Conferma Eliminazione", `Sei sicuro di voler RIMUOVERE il mobile '${name}' dalla vendita?`, 'error', async () => {
                showLoader(true);
                try {
                    await deleteDoc(doc(getProductsCollection(), id));
                    showMessageBox("Successo", `Mobile '${name}' rimosso con successo.`, "success");
                } catch (error) {
                    console.error("Errore nell'eliminazione del mobile:", error);
                    showMessageBox("Errore", "Impossibile rimuovere il mobile.", "error");
                }
                showLoader(false);
            });
        }
        
        const handleProductPurchase = (productId, productName) => {
             // Simula l'acquisto, dato che l'utente ha detto che la consegna è a scuola e non ha chiesto una logica di transazione complessa.
            showMessageBox("Conferma Acquisto", `Sei sicuro di voler acquistare il mobile '${productName}'? L'accordo sarà finalizzato e il prodotto consegnato a scuola.`, 'info', () => {
                 // Qui si potrebbe aggiungere una transazione di puntine o un log, ma per ora basta un messaggio di successo.
                 showMessageBox("Acquisto Confermato", `Complimenti, hai "acquistato" '${productName}'. Un Capo Azienda Mobili Puntina ti contatterà per la consegna a scuola!`, "success");
                 console.log(`Acquisto simulato: ${currentUserData.username} ha comprato ${productName} (ID: ${productId})`);
            });
        }


        // --- CALENDAR LOGIC AND UI ---
        
        const generateCalendarHtml = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth(); 
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

            const daysOfWeek = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const startDayOfWeek = firstDayOfMonth.getDay(); 

            const monthString = year + '-' + String(month + 1).padStart(2, '0');
            const monthlyEvents = (window.calendarEvents || []).filter(event => 
                event.date && event.date.startsWith(monthString)
            );

            const eventsMap = monthlyEvents.reduce((acc, event) => {
                const day = parseInt(event.date.substring(8, 10), 10);
                if (!acc[day]) acc[day] = [];
                acc[day].push(event);
                return acc;
            }, {});

            let calendarGrid = '';
            let day = 1;

            for (let i = 0; i < startDayOfWeek; i++) {
                calendarGrid += `<div class="p-2 border border-gray-100 bg-gray-50/50 text-gray-400"></div>`;
            }

            while (day <= daysInMonth) {
                const dateString = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                const isToday = isCurrentMonth && day === today.getDate();
                const dayEvents = eventsMap[day] || [];

                const dayClasses = `p-2 border border-gray-200 h-24 sm:h-32 relative transition-colors cursor-default ${isToday ? 'bg-indigo-100 border-indigo-400 font-bold' : 'bg-white hover:bg-gray-50'}`;

                let eventHtml = '';
                if (dayEvents.length > 0) {
                    eventHtml = dayEvents.map(event => `
                        <div class="mt-1 text-xs truncate bg-red-500 text-white rounded px-1.5 py-0.5" 
                             title="${event.title}: ${event.description}">
                            ${event.title}
                        </div>
                    `).join('');
                }

                calendarGrid += `
                    <div class="${dayClasses}">
                        <div class="text-right text-sm">${day}</div>
                        ${eventHtml}
                    </div>
                `;
                day++;
            }

            const monthYearString = date.toLocaleDateString('it-IT', { year: 'numeric', month: 'long' });
            
            const headerHtml = `
                <div class="flex justify-between items-center mb-4 p-4 bg-indigo-50 rounded-t-xl">
                    <button onclick="window.navigateCalendar(-1)" class="btn-secondary px-3 py-1 text-sm">&lt; Precedente</button>
                    <h2 class="text-xl font-bold text-indigo-800">${monthYearString.charAt(0).toUpperCase() + monthYearString.slice(1)}</h2>
                    <button onclick="window.navigateCalendar(1)" class="btn-secondary px-3 py-1 text-sm">Successivo &gt;</button>
                </div>
            `;

            const bodyHtml = `
                <div class="grid grid-cols-7 text-center font-semibold text-gray-700 border-t border-b border-gray-300">
                    ${daysOfWeek.map(day => `<div class="p-2 text-sm">${day}</div>`).join('')}
                </div>
                <div class="grid grid-cols-7" id="calendar-grid">
                    ${calendarGrid}
                </div>
            `;

            return headerHtml + bodyHtml;
        };

        const navigateCalendar = (offset) => {
            const newDate = new Date(window.currentCalendarDate);
            newDate.setMonth(newDate.getMonth() + offset);
            renderCalendarView(newDate);
        };
        
        const handleBackToDashboard = () => {
             if (isAdmin) {
                renderAdminDashboard();
            } else if (isMobiliHead) {
                renderMobiliPuntinaHeadDashboard();
            } else {
                renderUserDashboard();
            }
        }
        
        const renderCalendarView = (date = window.currentCalendarDate) => {
            window.currentCalendarDate = date; 
            
            const adminControls = isAdmin ? `
                <div class="mb-6 p-4 border border-indigo-300 bg-indigo-50 rounded-xl flex justify-between items-center">
                    <p class="text-indigo-700 font-medium">Gestione Eventi (Admin)</p>
                    <button onclick="window.renderEventModal()" class="btn-primary flex items-center w-auto px-4 py-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Aggiungi Evento
                    </button>
                </div>
            ` : '';
            
            const backButton = `
                <div class="mb-4">
                    <button onclick="window.handleBackToDashboard()" class="text-sm text-indigo-500 hover:text-indigo-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Torna alla Dashboard
                    </button>
                </div>
            `;

            const html = `
                <div id="calendar-container" class="w-full">
                    ${backButton}
                    <h1 class="text-3xl header text-center">Calendario Eventi</h1>
                    ${adminControls}
                    <div class="calendar-box border border-gray-300 rounded-xl overflow-hidden shadow-xl">
                        ${generateCalendarHtml(date)}
                    </div>
                </div>
            `;
            showView(html);
        };
        
        const renderEventModal = (date = null) => {
            if (!isAdmin) return;
            const container = document.getElementById('app-container');
            const existingModal = document.getElementById('event-modal');
            if (existingModal) existingModal.remove();

            const todayString = new Date().toISOString().substring(0, 10);
            const initialDate = date ? date.toISOString().substring(0, 10) : todayString;

            const modalHTML = `
                <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="card max-w-md">
                        <h3 class="text-lg font-bold text-gray-900 border-b pb-3 mb-4">Aggiungi Nuovo Evento</h3>
                        
                        <label class="block text-sm font-medium text-gray-700 mb-1">Titolo Evento</label>
                        <input type="text" id="event_title" placeholder="Riunione, Scadenza, Fiera..." class="w-full p-3 mb-4 border border-gray-300 rounded-lg" required />
                        
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                        <input type="date" id="event_date" value="${initialDate}" class="w-full p-3 mb-4 border border-gray-300 rounded-lg" required />

                        <label class="block text-sm font-medium text-gray-700 mb-1">Descrizione (facoltativa)</label>
                        <textarea id="event_description" placeholder="Dettagli dell'evento..." class="w-full p-3 mb-6 border border-gray-300 rounded-lg"></textarea>
                        
                        <div class="flex justify-end space-x-3">
                            <button onclick="document.getElementById('event-modal').remove()" class="btn-secondary w-auto px-4 py-2">Annulla</button>
                            <button onclick="window.submitNewEvent()" class="btn-primary w-auto px-4 py-2">Salva Evento</button>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('afterend', modalHTML);
        };

        const submitNewEvent = async () => {
            if (!isAdmin) return;
            const title = document.getElementById('event_title').value.trim();
            const date = document.getElementById('event_date').value;
            const description = document.getElementById('event_description').value.trim();

            if (!title || !date) {
                showMessageBox("Attenzione", "Inserisci il titolo e la data dell'evento.", "alert");
                return;
            }

            document.getElementById('event-modal').remove(); 
            showLoader(true);
            
            try {
                await addDoc(getEventsCollection(), {
                    title: title,
                    date: date, 
                    description: description,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUserData.username
                });
                showMessageBox("Successo", `L'evento '${title}' è stato aggiunto al calendario.`, "success");
            } catch (error) {
                console.error("Errore nell'aggiunta dell'evento:", error);
                showMessageBox("Errore", "Impossibile salvare l'evento.", "error");
            }
            showLoader(false);
        };


        // --- MAIN APPLICATION FLOW ---

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;

                if (currentUserData) {
                    // Logica già gestita da handleSignIn o da listeners
                } else {
                    showLoader(false);
                    renderWelcomeScreen();
                }
            } else {
                showLoader(false);
                renderWelcomeScreen();
            }
        });

        initializeAuth();
        
        // ***************************************************************
        // --- ESPOSIZIONE DELLE FUNZIONI GLOBALI (CRITICO PER IL FUNZIONAMENTO DEI PULSANTI) ---
        // ***************************************************************
        window.handleLogout = handleLogout;
        window.handleLoginClick = handleLoginClick;
        window.submitThumbtackRequest = submitThumbtackRequest;
        window.handleRankChange = handleRankChange;
        window.handleRequestAction = handleRequestAction;
        window.handleAdminPasswordChange = handleAdminPasswordChange;
        // Funzione per l'assegnazione dei lavori/ruoli (Banker/Capo Azienda)
        window.handleJobAssignment = handleJobAssignment; 

        // CALENDAR FUNCTIONS
        window.renderCalendarView = renderCalendarView;
        window.navigateCalendar = navigateCalendar;
        window.renderEventModal = renderEventModal;
        window.submitNewEvent = submitNewEvent;
        window.handleBackToDashboard = handleBackToDashboard;
        
        // CARD FUNCTIONS
        window.registerNewCard = registerNewCard;
        window.renderBalanceModal = renderBalanceModal;
        window.handleAdminCardAction = handleAdminCardAction;
        
        // PRODUCT / MARKETPLACE FUNCTIONS
        window.renderMarketplaceView = renderMarketplaceView;
        window.renderMobiliPuntinaHeadDashboard = renderMobiliPuntinaHeadDashboard;
        window.renderProductModal = renderProductModal;
        window.submitNewProduct = submitNewProduct;
        window.deleteProduct = deleteProduct;
        window.handleProductPurchase = handleProductPurchase;
        
    </script>
</body>
</html>
